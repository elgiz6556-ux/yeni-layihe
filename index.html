<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>X-Chat Ultimate PRO + Settings</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --bg: #0b0d10; --panel: #16191f; --blue: #3b82f6; 
            --me: #2b5278; --other: #1c2128; --text: #ffffff; 
        }
        .theme-blue { --bg: #0a192f; --panel: #112240; --me: #233554; --blue: #64ffda; }
        .theme-purple { --bg: #1a1025; --panel: #2d1b3d; --me: #4b2d61; --blue: #bd93f9; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100dvh; overflow: hidden; transition: 0.3s; }

        /* Gƒ∞Rƒ∞≈û EKRANI */
        #loginPage { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .card { background: var(--panel); width: 100%; max-width: 400px; padding: 30px; border-radius: 28px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        
        .ava-box { width: 90px; height: 90px; border-radius: 50%; background: #000; margin: 0 auto 15px; border: 2px dashed var(--blue); display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; position: relative; }
        .ava-box img { width: 100%; height: 100%; object-fit: cover; }

        input { width: 100%; background: #000; border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 14px; border-radius: 12px; margin-bottom: 15px; outline: none; }
        .main-btn { width: 100%; background: var(--blue); color: #fff; border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* APP STRUCTURE */
        #mainApp { display: none; height: 100%; flex-direction: column; }
        header { background: var(--panel); padding: max(10px, env(safe-area-inset-top)) 15px 10px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg-box { max-width: 80%; padding: 10px 14px; border-radius: 18px; position: relative; animation: fadeIn 0.3s; }
        .me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; background: var(--other); border-bottom-left-radius: 4px; }

        .footer { background: var(--panel); padding: 10px 10px calc(env(safe-area-inset-bottom) + 10px); display: flex; align-items: center; gap: 8px; }
        .inp-wrap { flex: 1; background: #000; border-radius: 24px; padding: 0 15px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        #mInp { border: none; background: transparent; color: #fff; padding: 10px 0; flex: 1; outline: none; }

        /* SHEETS */
        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; }
        .sheet-overlay.active { display: flex; }
        .sheet { width: 100%; background: var(--panel); border-radius: 24px 24px 0 0; padding: 20px; transform: translateY(100%); transition: 0.3s; padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        .sheet-overlay.active .sheet { transform: translateY(0); }
        .sheet-btn { width: 100%; padding: 15px; background: rgba(255,255,255,0.05); border: none; color: #fff; border-radius: 12px; margin-bottom: 8px; text-align: left; font-size: 15px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        img.msg-img { max-width: 100%; border-radius: 12px; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="card">
            <h2>X-Chat</h2>
            <div class="ava-box" onclick="document.getElementById('avaFile').click()">
                <img id="avaPrev" style="display:none">
                <span id="avaPlus">üì∏</span>
            </div>
            <input type="file" id="avaFile" hidden accept="image/*" onchange="uploadAva(true)">
            <input type="text" id="nickInp" placeholder="Adƒ±nƒ±z">
            <button class="main-btn" id="loginBtn" onclick="handleLogin()">Daxil Ol</button>
        </div>
    </div>

    <div id="mainApp">
        <header>
            <div style="display:flex; align-items:center; gap:10px" onclick="openSheet('settingsSheet')">
                <img id="myAva" style="width:38px; height:38px; border-radius:50%; border:1px solid var(--blue); object-fit:cover">
                <div>
                    <b id="roomTitle">General</b>
                    <div style="font-size:10px; opacity:0.6">Ayarlar √º√ß√ºn toxun</div>
                </div>
            </div>
            <div style="font-size:22px" onclick="openSheet('themeSheet')">üé®</div>
        </header>

        <div id="chat"></div>

        <div class="footer">
            <span onclick="openSheet('attachSheet')" style="font-size:25px; padding:0 8px">+</span>
            <div class="inp-wrap">
                <input type="text" id="mInp" placeholder="Mesaj..." onkeypress="if(event.key==='Enter') sendText()">
            </div>
            <button onclick="sendText()" style="background:var(--blue); border:none; color:#fff; width:40px; height:40px; border-radius:50%">‚û§</button>
        </div>
    </div>

    <div id="settingsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3 style="margin-top:0">Profil Ayarlarƒ±</h3>
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px">
            <div class="ava-box" style="margin:0; width:70px; height:70px" onclick="document.getElementById('changeAvaFile').click()">
                <img id="settingsAva" src="">
                <input type="file" id="changeAvaFile" hidden accept="image/*" onchange="uploadAva(false)">
            </div>
            <div style="flex:1">
                <input type="text" id="changeNickInp" style="margin:0; padding:8px" placeholder="Yeni ad">
                <button class="main-btn" style="padding:8px; margin-top:5px; font-size:12px" onclick="updateProfile()">Yadda Saxla</button>
            </div>
        </div>
        <button class="sheet-btn" onclick="goGlobal()">üåê Qlobal √áata Qayƒ±t</button>
        <button class="sheet-btn" onclick="changeRoom()">üîí Otaq D…ôyi≈ü</button>
        <button class="sheet-btn" style="color:#ef4444" onclick="logout()">üõë Hesabdan √áƒ±x</button>
    </div></div>

    <div id="themeSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="setTheme('')">üåë Gec…ô</button>
        <button class="sheet-btn" onclick="setTheme('theme-blue')">üåä Okean</button>
        <button class="sheet-btn" onclick="setTheme('theme-purple')">üîÆ B…ôn√∂v≈ü…ôyi</button>
    </div></div>

    <div id="attachSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="document.getElementById('fInp').click()">üñº ≈û…ôkil G√∂nd…ôr</button>
        <button class="sheet-btn" onclick="sendLoc()">üìç M…ôkan Payla≈ü</button>
    </div></div>

    <div id="dmSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <h3 id="dmTargetName" style="text-align:center"></h3>
        <button id="dmBtn" class="sheet-btn" style="background:var(--blue); text-align:center">üí¨ Mesaj Yaz</button>
    </div></div>

    <input type="file" id="fInp" hidden accept="image/*" onchange="uploadFile()">

<script>
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user'));
    let room = 'General', uploadedUrl = "";

    function checkLogin() {
        if(user) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            document.getElementById('myAva').src = user.ava;
            document.getElementById('settingsAva').src = user.ava;
            document.getElementById('changeNickInp').value = user.nick;
            initChat();
        }
    }

    async function uploadAva(isLogin) {
        const file = isLogin ? document.getElementById('avaFile').files[0] : document.getElementById('changeAvaFile').files[0];
        if(!file) return;

        const name = `ava_${Date.now()}.png`;
        const { data } = await sb.storage.from('audio_messages').upload(name, file);
        uploadedUrl = `${SB_URL}/storage/v1/object/public/audio_messages/${name}`;
        
        if(isLogin) {
            document.getElementById('avaPrev').src = uploadedUrl;
            document.getElementById('avaPrev').style.display = 'block';
            document.getElementById('avaPlus').style.display = 'none';
        } else {
            document.getElementById('settingsAva').src = uploadedUrl;
            // Ayarlar zamanƒ± d…ôrhal profil…ô t…ôtbiq etm…ôk √º√ß√ºn updateProfile √ßaƒüƒ±ra bil…ôrik
        }
    }

    function handleLogin() {
        const nick = document.getElementById('nickInp').value.trim();
        if(!nick) return alert('Adƒ±nƒ±zƒ± yazƒ±n');
        const ava = uploadedUrl || `https://ui-avatars.com/api/?name=${nick}&background=random`;
        user = { nick, ava };
        localStorage.setItem('x_user', JSON.stringify(user));
        location.reload();
    }

    function updateProfile() {
        const newNick = document.getElementById('changeNickInp').value.trim();
        if(!newNick) return;
        user.nick = newNick;
        if(uploadedUrl) user.ava = uploadedUrl;
        localStorage.setItem('x_user', JSON.stringify(user));
        alert("Profil yenil…ôndi!");
        location.reload();
    }

    // √áAT FUNKSƒ∞YALARI
    function initChat() {
        document.body.className = localStorage.getItem('theme') || '';
        loadMsgs();
        sb.channel('updates').on('postgres_changes',{event:'*',schema:'public',table:'messages'},() => loadMsgs()).subscribe();
    }

    async function loadMsgs() {
        const { data } = await sb.from('messages').select('*').eq('group_id', room).order('created_at',{ascending:true});
        const chatDiv = document.getElementById('chat'); chatDiv.innerHTML = '';
        data.forEach(m => {
            const isMe = m.nickname === user.nick;
            let body = '', j;
            try { j = JSON.parse(m.content);
                if(j.type==='image') body = `<img src="${j.url}" class="msg-img">`;
                else if(j.type==='loc') body = `<a href="${j.url}" target="_blank" style="color:var(--blue)">üìç M…ôkan</a>`;
                else body = j.text;
            } catch { body = m.content; }

            const div = document.createElement('div');
            div.className = `msg-box ${isMe ? 'me' : 'other'}`;
            div.innerHTML = `
                ${!isMe ? `<b onclick="openDM('${m.nickname}')" style="color:var(--blue);font-size:11px;display:block;margin-bottom:2px">üë§ ${m.nickname}</b>` : ''}
                ${body}
                <div style="font-size:9px;opacity:0.4;text-align:right;margin-top:3px">${new Date(m.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
            `;
            chatDiv.appendChild(div);
        });
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    async function sendText() {
        const i = document.getElementById('mInp'); if(!i.value.trim()) return;
        const val = i.value; i.value = '';
        await sb.from('messages').insert([{ nickname:user.nick, group_id:room, content: JSON.stringify({text:val, type:'text'}) }]);
    }

    function openDM(target) {
        document.getElementById('dmTargetName').innerText = target;
        document.getElementById('dmBtn').onclick = () => {
            room = 'DM_' + [user.nick, target].sort().join('_');
            document.getElementById('roomTitle').innerText = 'üë§ ' + target;
            closeSheets(); loadMsgs();
        };
        openSheet('dmSheet');
    }

    function logout() { localStorage.clear(); location.reload(); }
    function goGlobal() { room = 'General'; document.getElementById('roomTitle').innerText = 'General'; closeSheets(); loadMsgs(); }
    function openSheet(id) { document.getElementById(id).classList.add('active'); }
    function closeSheets() { document.querySelectorAll('.sheet-overlay').forEach(s => s.classList.remove('active')); }
    function setTheme(t) { document.body.className = t; localStorage.setItem('theme', t); closeSheets(); }
    function changeRoom() { const n = prompt('Otaq:'); if(n) { room = n; document.getElementById('roomTitle').innerText = n; loadMsgs(); } closeSheets(); }

    checkLogin();
</script>
</body>
</html>
 
