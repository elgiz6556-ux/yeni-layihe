<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>X-Chat V12 SUPREME</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --bg: #0b0d10; --panel: #16191f; --blue: #3b82f6; 
            --me: #2b5278; --other: #1c2128; --text: #ffffff; 
            --ghost: linear-gradient(45deg, #4b5563, #1f2937);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; }
        
        body { 
            background: var(--bg); color: var(--text); 
            height: 100dvh; display: flex; flex-direction: column; 
            overflow: hidden; transition: background 1s ease;
        }

        /* --- LOGIN PAGE --- */
        #loginPage { 
            position: fixed; inset: 0; background: var(--bg); z-index: 5000; 
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .login-card { 
            background: var(--panel); width: 100%; max-width: 400px; 
            padding: 40px 25px; border-radius: 30px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* --- HEADER --- */
        header { 
            background: var(--panel); padding: 45px 15px 10px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 100;
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--blue); object-fit: cover; }
        
        /* --- CHAT AREA --- */
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg-box { 
            max-width: 85%; padding: 12px 16px; border-radius: 20px; 
            position: relative; font-size: 15px; line-height: 1.4;
            animation: msgPop 0.3s ease-out; word-wrap: break-word;
        }
        .me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; background: var(--other); border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }
        
        .ghost-msg { 
            background: var(--ghost) !important; border: 1px dashed rgba(255,255,255,0.4); 
            animation: evaporate 10s forwards !important; 
        }
        @keyframes evaporate { 80% { opacity: 0.5; filter: blur(2px); } 100% { opacity: 0; filter: blur(10px); visibility: hidden; } }
        @keyframes msgPop { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- FOOTER --- */
        #replyBar { display: none; background: #000; padding: 10px 15px; border-top: 2px solid var(--blue); font-size: 12px; justify-content: space-between; align-items: center; }
        .footer { background: var(--panel); padding: 10px 10px 35px; display: flex; align-items: center; gap: 10px; }
        .inp-wrap { flex: 1; background: #000; border-radius: 25px; padding: 0 15px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        #mInp { border: none; background: transparent; color: #fff; padding: 12px 0; flex: 1; outline: none; font-size: 15px; }
        
        .btn-icon { font-size: 24px; color: var(--blue); cursor: pointer; transition: 0.2s; }
        .ghost-toggle { 
            width: 38px; height: 38px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center; font-size: 18px;
        }
        .ghost-toggle.active { background: var(--blue); box-shadow: 0 0 15px var(--blue); border: none; }

        /* --- MODALS (SHEETS) --- */
        .sheet-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; 
            display: none; align-items: flex-end; backdrop-filter: blur(8px); 
        }
        .sheet-overlay.active { display: flex; }
        .sheet { 
            width: 100%; background: var(--panel); border-radius: 30px 30px 0 0; 
            padding: 25px; transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            max-height: 85vh; overflow-y: auto;
        }
        .sheet-overlay.active .sheet { transform: translateY(0); }
        .sheet-btn { 
            width: 100%; padding: 16px; background: rgba(255,255,255,0.05); 
            border: none; color: #fff; border-radius: 18px; margin-bottom: 12px; 
            text-align: left; display: flex; align-items: center; gap: 15px; font-size: 16px;
        }

        /* --- SOCIAL COMPONENTS --- */
        .badge { background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; position: absolute; top: -5px; right: -5px; }
        .friend-item { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 15px; margin-bottom: 10px; }
        
        audio { width: 200px; height: 40px; filter: invert(1); }
        img.chat-img { max-width: 100%; border-radius: 15px; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-card">
            <h2 style="margin-bottom: 25px; color: var(--blue);">X-Chat SUPREME</h2>
            <div id="avaSelect" style="width: 90px; height: 90px; border-radius: 50%; background: #000; margin: 0 auto 20px; border: 2px dashed var(--blue); display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer;" onclick="document.getElementById('avaFile').click()">
                <img id="avaPrev" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                <span id="avaPlaceholder" style="font-size: 30px;">üì∏</span>
            </div>
            <input type="file" id="avaFile" hidden accept="image/*" onchange="previewAva()">
            <input type="text" id="nickInp" style="width: 100%; padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); background: #000; color: #fff; margin-bottom: 20px; outline: none;" placeholder="L…ôq…ôbinizi yazƒ±n...">
            <button onclick="doLogin()" style="width: 100%; padding: 15px; background: var(--blue); border: none; color: white; border-radius: 15px; font-weight: bold; font-size: 16px;">Ba≈üla</button>
        </div>
    </div>

    <div id="app" style="display: none; height: 100%; flex-direction: column;">
        <header>
            <div class="top-bar">
                <div class="user-info" onclick="openSheet('settingsSheet')">
                    <img id="myAvaImg" src="">
                    <div>
                        <b id="roomTitle">Qlobal √áat</b>
                        <div id="moodTag" style="font-size: 10px; color: #10b981;">‚óè Online</div>
                    </div>
                </div>
                <div style="display: flex; gap: 20px;">
                    <span class="btn-icon" onclick="openFriends()" style="position: relative;">üë•<div id="reqCount" class="badge" style="display: none;">0</div></span>
                    <span class="btn-icon" onclick="openRooms()">üè†</span>
                </div>
            </div>
        </header>

        <div id="chat"></div>

        <div id="replyBar">
            <div id="replyContent" style="opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
            <span onclick="cancelReply()" style="color: #ef4444; font-weight: bold; cursor: pointer; padding: 5px;">X</span>
        </div>

        <div class="footer">
            <span class="btn-icon" onclick="openSheet('attachSheet')">+</span>
            <div id="ghostBtn" class="ghost-toggle" onclick="toggleGhost()" title="Duman Rejimi">üëª</div>
            <div class="inp-wrap">
                <input type="text" id="mInp" placeholder="Mesaj yaz..." onkeypress="if(event.key==='Enter') sendMsg()">
            </div>
            <button onclick="sendMsg()" style="background: var(--blue); border: none; color: white; width: 42px; height: 42px; border-radius: 50%; font-size: 18px;">‚û§</button>
        </div>
    </div>

    <div id="friendsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Sosial Panel</h3>
        <div id="socialTabs" style="display: flex; gap: 10px; margin: 15px 0;">
            <button onclick="renderSocial('friends')" style="flex:1; padding:10px; border-radius:10px; border:none; background:var(--blue); color:white;">Dostlar</button>
            <button onclick="renderSocial('reqs')" style="flex:1; padding:10px; border-radius:10px; border:none; background:rgba(255,255,255,0.1); color:white;">ƒ∞st…ôkl…ôr</button>
        </div>
        <div id="socialList"></div>
    </div></div>

    <div id="roomsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Otaqlar</h3>
        <button class="sheet-btn" onclick="createRoom()" style="background: var(--blue); margin-top: 15px; font-weight: bold;">‚ûï Yeni Otaq Yarat</button>
        <div id="roomsList" style="margin-top: 10px;"></div>
    </div></div>

    <div id="attachSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="document.getElementById('fInp').click()">üñº ≈û…ôkil G√∂nd…ôr</button>
        <button class="sheet-btn" onclick="handleVoice()">üéô S…ôsli Mesaj</button>
        <button class="sheet-btn" onclick="sendLocation()">üìç M…ôkan Payla≈ü</button>
    </div></div>

    <div id="profileSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="pAva" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--blue); object-fit: cover;">
            <h2 id="pNick" style="margin-top: 10px;"></h2>
        </div>
        <button class="sheet-btn" id="dmBtn" style="background: var(--blue); justify-content: center;">üí¨ ≈û…ôxsi Mesaj (DM)</button>
        <button class="sheet-btn" id="addFriendBtn" style="border: 1px solid var(--blue); justify-content: center;">ü§ù Dostluq ƒ∞st…ôyi G√∂nd…ôr</button>
    </div></div>

    <div id="settingsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="switchRoom('General')">üåç Qlobal √áata D√∂n</button>
        <button class="sheet-btn" onclick="logout()" style="color: #ef4444;">üõë √áƒ±xƒ±≈ü Et</button>
    </div></div>

    <input type="file" id="fInp" hidden accept="image/*" onchange="uploadImage()">

<script>
    // --- KONFƒ∞QURASƒ∞YA ---
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user'));
    let currentRoom = 'General';
    let isGhost = false;
    let replyTo = null;
    let friends = JSON.parse(localStorage.getItem('x_friends')) || [];
    let pendingReqs = [];
    let mediaRecorder, chunks = [];
    let uploadedAvaUrl = "";

    // --- Gƒ∞Rƒ∞≈û & PROFƒ∞L ---
    async function previewAva() {
        const file = document.getElementById('avaFile').files[0];
        const name = `ava_${Date.now()}.png`;
        await sb.storage.from('audio_messages').upload(name, file);
        uploadedAvaUrl = `${SB_URL}/storage/v1/object/public/audio_messages/${name}`;
        document.getElementById('avaPrev').src = uploadedAvaUrl;
        document.getElementById('avaPrev').style.display = 'block';
        document.getElementById('avaPlaceholder').style.display = 'none';
    }

    function doLogin() {
        const nick = document.getElementById('nickInp').value.trim();
        if(!nick) return alert("L…ôq…ôb vacibdir!");
        user = { nick, ava: uploadedAvaUrl || `https://ui-avatars.com/api/?name=${nick}&background=random` };
        localStorage.setItem('x_user', JSON.stringify(user));
        location.reload();
    }

    // --- REALTIME & Bƒ∞LDƒ∞Rƒ∞≈ûL∆èR ---
    function startApp() {
        if(!user) return;
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        document.getElementById('myAvaImg').src = user.ava;
        
        loadMessages();
        fetchRequests();
        
        // Supabase Realtime
        sb.channel('db_changes').on('postgres_changes', {event:'*', schema:'public', table:'messages'}, p => {
            const m = p.new;
            if(m.group_id === currentRoom) loadMessages();
            if(m.group_id === 'REQ_' + user.nick) fetchRequests();
            if(m.group_id.startsWith('DM_') && m.nickname !== user.nick) {
                if(currentRoom !== m.group_id) notify("Yeni DM!", `${m.nickname} s…ôn…ô yazdƒ±.`);
            }
        }).subscribe();

        // Mood Sync (Hava/Saat effekti)
        const hour = new Date().getHours();
        if(hour > 19 || hour < 7) {
            document.body.style.background = "#05070a";
            document.getElementById('moodTag').innerText = "‚ú® Mood: Gec…ô rejimi";
        }
    }

    // --- MESAJLA≈ûMA ---
    async function loadMessages() {
        const { data } = await sb.from('messages').select('*').eq('group_id', currentRoom).order('created_at', {ascending: true});
        const chat = document.getElementById('chat'); chat.innerHTML = '';
        data.forEach(m => {
            let j = {}; try { j = JSON.parse(m.content); } catch { j = {text: m.content}; }
            const isMe = m.nickname === user.nick;
            const div = document.createElement('div');
            div.className = `msg-box ${isMe ? 'me' : 'other'} ${j.mode === 'ghost' ? 'ghost-msg' : ''}`;
            
            let html = '';
            if(j.reply) html += `<div style="font-size:10px; opacity:0.6; border-left:2px solid var(--blue); padding-left:5px; margin-bottom:5px;"><b>${j.reply.to}:</b> ${j.reply.txt}</div>`;
            if(j.type === 'audio') html += `<audio src="${j.url}" controls></audio>`;
            else if(j.type === 'image') html += `<img src="${j.url}" class="chat-img">`;
            else if(j.type === 'loc') html += `<a href="${j.url}" target="_blank" style="color:cyan; font-size:13px;">üìç Payla≈üƒ±lan M…ôkan</a>`;
            else html += `<div>${j.text}</div>`;

            div.innerHTML = `${!isMe ? `<b onclick="openUserProfile('${m.nickname}','${j.ava}')" style="font-size:11px; color:var(--blue); cursor:pointer;">${m.nickname}</b><br>` : ''}${html}`;
            div.onclick = () => setReply(m.nickname, j.text || "Media");
            chat.appendChild(div);

            // Duman rejimi t…ômizliyi (10 saniy…ô)
            if(j.mode === 'ghost' && isMe) {
                setTimeout(async () => { await sb.from('messages').delete().eq('id', m.id); }, 10000);
            }
        });
        chat.scrollTop = chat.scrollHeight;
    }

    async function sendMsg(extra = {}) {
        const inp = document.getElementById('mInp');
        const txt = inp.value.trim();
        if(!txt && !extra.type) return;

        const payload = { text: txt, ava: user.ava, mode: isGhost ? 'ghost' : 'normal', ...extra };
        if(replyTo) { payload.reply = replyTo; cancelReply(); }
        
        inp.value = '';
        if(isGhost) toggleGhost();

        await sb.from('messages').insert([{ nickname: user.nick, group_id: currentRoom, content: JSON.stringify(payload) }]);
    }

    // --- DOSTLUQ & DM Sƒ∞STEMƒ∞ ---
    function openUserProfile(nick, ava) {
        if(nick === user.nick) return;
        document.getElementById('pNick').innerText = nick;
        document.getElementById('pAva').src = ava;
        
        document.getElementById('dmBtn').onclick = () => {
            const dmID = "DM_" + [user.nick, nick].sort().join("_");
            switchRoom(dmID);
        };
        
        document.getElementById('addFriendBtn').onclick = async () => {
            const payload = { type: 'friend_req', from: user.nick, ava: user.ava };
            await sb.from('messages').insert([{ nickname: user.nick, group_id: 'REQ_' + nick, content: JSON.stringify(payload) }]);
            alert("Dostluq ist…ôyi g√∂nd…ôrildi!");
        };
        
        openSheet('profileSheet');
    }

    async function fetchRequests() {
        const { data } = await sb.from('messages').select('*').eq('group_id', 'REQ_' + user.nick);
        pendingReqs = data;
        const count = data.length;
        document.getElementById('reqCount').innerText = count;
        document.getElementById('reqCount').style.display = count > 0 ? 'block' : 'none';
    }

    function renderSocial(tab) {
        const list = document.getElementById('socialList'); list.innerHTML = '';
        if(tab === 'friends') {
            friends.forEach(f => {
                list.innerHTML += `<div class="friend-item" onclick="openUserProfile('${f.nick}','${f.ava}')">
                    <span>üë§ ${f.nick}</span>
                    <button style="border:none; background:var(--blue); color:white; padding:5px 10px; border-radius:8px;">Profil</button>
                </div>`;
            });
        } else {
            pendingReqs.forEach(r => {
                const d = JSON.parse(r.content);
                list.innerHTML += `<div class="friend-item">
                    <span>ü§ù ${d.from}</span>
                    <button onclick="acceptFriend('${r.id}', '${d.from}', '${d.ava}')" style="background:#10b981; border:none; color:white; padding:5px 10px; border-radius:8px;">Q…ôbul</button>
                </div>`;
            });
        }
    }

    async function acceptFriend(msgId, nick, ava) {
        friends.push({nick, ava});
        localStorage.setItem('x_friends', JSON.stringify(friends));
        await sb.from('messages').delete().eq('id', msgId);
        fetchRequests(); renderSocial('reqs');
    }

    // --- TOOLS (S∆èS, ≈û∆èKƒ∞L, KONUM) ---
    async function handleVoice() {
        if(!mediaRecorder || mediaRecorder.state === 'inactive') {
            const stream = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(chunks, {type:'audio/webm'});
                const name = `voice_${Date.now()}.webm`;
                await sb.storage.from('audio_messages').upload(name, blob);
                sendMsg({type:'audio', url: `${SB_URL}/storage/v1/object/public/audio_messages/${name}`});
            };
            mediaRecorder.start();
            alert("S…ôs yazƒ±lƒ±r... Dayandƒ±rmaq √º√ß√ºn yenid…ôn basƒ±n.");
        } else {
            mediaRecorder.stop();
        }
        closeSheets();
    }

    async function uploadImage() {
        const file = document.getElementById('fInp').files[0]; if(!file) return;
        const name = `img_${Date.now()}`;
        await sb.storage.from('audio_messages').upload(name, file);
        sendMsg({type:'image', url: `${SB_URL}/storage/v1/object/public/audio_messages/${name}`});
        closeSheets();
    }

    function sendLocation() {
        navigator.geolocation.getCurrentPosition(p => {
            sendMsg({type:'loc', url: `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`});
            closeSheets();
        });
    }

    // --- UI NAVƒ∞QASƒ∞YA ---
    function toggleGhost() {
        isGhost = !isGhost;
        document.getElementById('ghostBtn').classList.toggle('active', isGhost);
        document.getElementById('mInp').placeholder = isGhost ? "Duman rejimind…ô yazƒ±lƒ±r..." : "Mesaj yaz...";
    }

    function setReply(to, txt) {
        replyTo = { to, txt };
        document.getElementById('replyContent').innerText = `${to}: ${txt}`;
        document.getElementById('replyBar').style.display = 'flex';
        document.getElementById('mInp').focus();
    }

    function cancelReply() { replyTo = null; document.getElementById('replyBar').style.display = 'none'; }

    function openFriends() { renderSocial('friends'); openSheet('friendsSheet'); }
    
    function openRooms() {
        const list = document.getElementById('roomsList'); list.innerHTML = '';
        const rooms = JSON.parse(localStorage.getItem('x_rooms')) || ["General", "Texnologiya", "Oyun"];
        rooms.forEach(r => {
            list.innerHTML += `<button class="sheet-btn" onclick="switchRoom('${r}')">üè† ${r}</button>`;
        });
        openSheet('roomsSheet');
    }

    function switchRoom(name) {
        currentRoom = name;
        document.getElementById('roomTitle').innerText = name.startsWith('DM_') ? "≈û…ôxsi S√∂hb…ôt" : name;
        closeSheets();
        loadMessages();
    }

    function openSheet(id) { document.getElementById(id).classList.add('active'); }
    function closeSheets() { document.querySelectorAll('.sheet-overlay').forEach(s => s.classList.remove('active')); }
    function notify(t, b) { if(Notification.permission === 'granted') new Notification(t, {body: b}); }
    function logout() { localStorage.clear(); location.reload(); }

    if(Notification.permission !== 'granted') Notification.requestPermission();
    startApp();
</script>
</body>
</html>
 
