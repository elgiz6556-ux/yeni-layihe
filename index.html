<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>X-Chat V13 PREMIUM</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0b0d10; --panel: #16191f; --blue: #3b82f6; --me: #2b5278; --other: #1c2128; --text: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        header { background: var(--panel); padding: 45px 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--blue); object-fit: cover; }

        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg-box { max-width: 82%; padding: 10px 14px; border-radius: 18px; position: relative; font-size: 15px; animation: pop 0.2s ease-out; }
        .me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; background: var(--other); border-bottom-left-radius: 4px; }

        .footer { background: var(--panel); padding: 10px 10px 35px; display: flex; align-items: center; gap: 10px; }
        .inp-wrap { flex: 1; background: #000; border-radius: 25px; padding: 0 15px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        #mInp { border: none; background: transparent; color: #fff; padding: 12px 0; flex: 1; outline: none; }

        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; backdrop-filter: blur(5px); }
        .sheet-overlay.active { display: flex; }
        .sheet { width: 100%; background: var(--panel); border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(100%); transition: 0.3s; max-height: 85vh; overflow-y: auto; }
        .sheet-overlay.active .sheet { transform: translateY(0); }
        
        .sheet-btn { width: 100%; padding: 15px; background: rgba(255,255,255,0.05); border: none; color: #fff; border-radius: 15px; margin-bottom: 10px; text-align: left; display: flex; align-items: center; gap: 10px; }
        input.edit-inp { width: 100%; background: #000; border: 1px solid var(--blue); color: #fff; padding: 12px; border-radius: 10px; margin-bottom: 10px; }

        @keyframes pop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <header>
        <div class="top-bar">
            <div class="user-info" onclick="openSheet('profileEditSheet')">
                <img id="headAva" src="">
                <div><b id="roomTitle">Qlobal √áat</b><div style="font-size:10px; color:#10b981">‚óè Online</div></div>
            </div>
            <div style="display:flex; gap:15px; font-size:22px">
                <span onclick="openSheet('friendsSheet')">üë•</span>
                <span onclick="renderRooms()">üè†</span>
            </div>
        </div>
    </header>

    <div id="chat"></div>

    <div class="footer">
        <span onclick="openSheet('attachSheet')" style="font-size:25px; color:var(--blue)">+</span>
        <div class="inp-wrap"><input type="text" id="mInp" placeholder="Mesaj..." onkeypress="if(event.key==='Enter') sendMsg()"></div>
        <button onclick="sendMsg()" style="background:var(--blue); border:none; color:#fff; width:40px; height:40px; border-radius:50%">‚û§</button>
    </div>

    <div id="profileEditSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Profili Redakt…ô Et</h3>
        <div style="text-align:center; margin:15px 0">
            <img id="editAvaPrev" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--blue); object-fit:cover">
            <button onclick="document.getElementById('newAvaFile').click()" style="display:block; margin:10px auto; background:none; border:none; color:var(--blue)">≈û…ôkli D…ôyi≈ü</button>
            <input type="file" id="newAvaFile" hidden accept="image/*" onchange="updateAvaPreview()">
        </div>
        <input type="text" id="editNick" class="edit-inp" placeholder="Yeni L…ôq…ôb">
        <input type="password" id="editPass" class="edit-inp" placeholder="Yeni Giri≈ü ≈ûifr…ôsi">
        <button class="sheet-btn" onclick="saveProfile()" style="background:var(--blue); justify-content:center; font-weight:bold">Yadda Saxla</button>
        <button class="sheet-btn" onclick="logout()" style="color:red; justify-content:center">√áƒ±xƒ±≈ü Et</button>
    </div></div>

    <div id="roomsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Otaqlar</h3>
        <button class="sheet-btn" onclick="createNewRoomUI()" style="background:var(--blue); font-weight:bold">‚ûï Yeni Otaq (≈ûifr…ôli/M…ôkanlƒ±)</button>
        <div id="roomsList" style="margin-top:10px"></div>
    </div></div>

    <div id="friendsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Dostlar</h3>
        <div id="friendsList"></div>
    </div></div>

    <div id="attachSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="document.getElementById('imgFile').click()">üñº ≈û…ôkil</button>
        <button class="sheet-btn" onclick="sendLocation()">üìç M…ôkan</button>
        <input type="file" id="imgFile" hidden onchange="uploadImg()">
    </div></div>

<script>
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user'));
    let currentRoom = { name: 'General' };
    let myRooms = JSON.parse(localStorage.getItem('x_rooms')) || [{ name: 'General' }];

    // --- BA≈ûLANƒûIC YOXLA ---
    if(!user) {
        const n = prompt("X-Chat-a xo≈ü g…ôldiniz! L…ôq…ôbiniz:");
        const p = prompt("Giri≈ü ≈üifr…ôsi t…ôyin edin:");
        user = { nick: n || 'Anonim', pass: p || '', ava: `https://ui-avatars.com/api/?name=${n}` };
        localStorage.setItem('x_user', JSON.stringify(user));
        location.reload();
    }

    function init() {
        document.getElementById('headAva').src = user.ava;
        document.getElementById('editAvaPrev').src = user.ava;
        document.getElementById('editNick').value = user.nick;
        loadMsgs();
        sb.channel('updates').on('postgres_changes', {event:'*', schema:'public', table:'messages'}, () => loadMsgs()).subscribe();
    }

    // --- MESAJLARI Y√úKL∆è ---
    async function loadMsgs() {
        const { data } = await sb.from('messages').select('*').eq('group_id', currentRoom.name).order('created_at', {ascending:true});
        const chat = document.getElementById('chat'); chat.innerHTML = '';
        data.forEach(m => {
            let j = {}; try { j = JSON.parse(m.content); } catch { j = {text: m.content}; }
            const isMe = m.nickname === user.nick;
            const div = document.createElement('div');
            div.className = `msg-box ${isMe ? 'me' : 'other'}`;
            
            let contentHtml = j.type === 'loc' ? `<a href="${j.url}" target="_blank" style="color:cyan">üìç M…ôkan Payla≈üdƒ±</a>` : 
                             (j.type === 'img' ? `<img src="${j.url}" style="max-width:100%; border-radius:10px">` : `<div>${j.text || ''}</div>`);
            
            div.innerHTML = `${!isMe ? `<b style="font-size:11px; color:var(--blue)">${m.nickname}</b><br>` : ''}${contentHtml}`;
            chat.appendChild(div);
        });
        chat.scrollTop = chat.scrollHeight;
    }

    async function sendMsg(extra = {}) {
        const inp = document.getElementById('mInp');
        if(!inp.value && !extra.type) return;
        const payload = { text: inp.value, ...extra };
        inp.value = '';
        await sb.from('messages').insert([{ nickname: user.nick, group_id: currentRoom.name, content: JSON.stringify(payload) }]);
    }

    // --- M∆èKAN ∆èSASLI OTAQ YARATMA ---
    function createNewRoomUI() {
        const name = prompt("Otaq adƒ±:"); if(!name) return;
        const type = confirm("Bu otaq M∆èKAN Kƒ∞Lƒ∞DLƒ∞ olsun? (Yalnƒ±z 100m yaxƒ±ndakƒ±lar gir…ô bilsin)");
        
        if(type) {
            navigator.geolocation.getCurrentPosition(pos => {
                const newR = { name, lat: pos.coords.latitude, lng: pos.coords.longitude, isZone: true };
                myRooms.push(newR);
                saveRooms();
            });
        } else {
            const pass = prompt("≈ûifr…ô qoyulsun? (Bo≈üdursa ≈üifr…ôsiz)");
            myRooms.push({ name, pass: pass || null, isZone: false });
            saveRooms();
        }
    }

    function renderRooms() {
        const list = document.getElementById('roomsList'); list.innerHTML = '';
        myRooms.forEach(r => {
            list.innerHTML += `<button class="sheet-btn" onclick='tryJoinRoom(${JSON.stringify(r)})'>
                üè† ${r.name} ${r.isZone ? 'üìç' : (r.pass ? 'üîí' : '')}
            </button>`;
        });
        openSheet('roomsSheet');
    }

    function tryJoinRoom(r) {
        if(r.isZone) {
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = getDist(pos.coords.latitude, pos.coords.longitude, r.lat, r.lng);
                if(dist > 0.1) return alert("Siz bu otaqdan √ßox uzaqdasƒ±nƒ±z!");
                enterRoom(r);
            });
        } else if(r.pass) {
            if(prompt("≈ûifr…ô:") !== r.pass) return alert("S…ôhv ≈üifr…ô!");
            enterRoom(r);
        } else {
            enterRoom(r);
        }
    }

    function enterRoom(r) {
        currentRoom = r;
        document.getElementById('roomTitle').innerText = r.name;
        closeSheets(); loadMsgs();
    }

    // --- PROFƒ∞L REDAKT∆è ---
    async function updateAvaPreview() {
        const file = document.getElementById('newAvaFile').files[0];
        const name = `ava_${Date.now()}.png`;
        await sb.storage.from('audio_messages').upload(name, file);
        const url = `${SB_URL}/storage/v1/object/public/audio_messages/${name}`;
        document.getElementById('editAvaPrev').src = url;
        user.tempAva = url;
    }

    function saveProfile() {
        user.nick = document.getElementById('editNick').value;
        if(document.getElementById('editPass').value) user.pass = document.getElementById('editPass').value;
        if(user.tempAva) user.ava = user.tempAva;
        localStorage.setItem('x_user', JSON.stringify(user));
        alert("Profil yenil…ôndi!");
        location.reload();
    }

    // --- K√ñM∆èK√áƒ∞ ---
    function getDist(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function saveRooms() { localStorage.setItem('x_rooms', JSON.stringify(myRooms)); renderRooms(); }
    function openSheet(id) { document.getElementById(id).classList.add('active'); }
    function closeSheets() { document.querySelectorAll('.sheet-overlay').forEach(s => s.classList.remove('active')); }
    function logout() { localStorage.clear(); location.reload(); }

    init();
</script>
</body>
</html>
