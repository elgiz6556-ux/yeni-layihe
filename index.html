<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>X-Chat V11 UNIVERSAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0b0d10; --panel: #16191f; --blue: #3b82f6; --me: #2b5278; --other: #1c2128; --text: #ffffff; --ghost: linear-gradient(45deg, #4b5563, #1f2937); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; transition: background 1s ease; }

        /* HEADER */
        header { background: var(--panel); padding: 45px 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 100; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; }
        .user-info img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--blue); object-fit: cover; }
        
        /* CHAT AREA */
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg-box { max-width: 82%; padding: 10px 14px; border-radius: 18px; position: relative; font-size: 15px; animation: pop 0.3s ease-out; word-wrap: break-word; }
        .me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; background: var(--other); border-bottom-left-radius: 4px; }
        
        /* GHOST MESSAGE EFFECT */
        .ghost-msg { background: var(--ghost) !important; border: 1px dashed rgba(255,255,255,0.4); animation: evaporate 10s forwards !important; }
        @keyframes evaporate { 0% { opacity: 1; filter: blur(0px); } 80% { opacity: 0.5; filter: blur(2px); } 100% { opacity: 0; filter: blur(10px); visibility: hidden; } }

        /* FOOTER & GHOST TOGGLE */
        #replyBar { display: none; background: #000; padding: 10px 15px; border-top: 2px solid var(--blue); font-size: 12px; justify-content: space-between; }
        .footer { background: var(--panel); padding: 10px 10px 35px; display: flex; align-items: center; gap: 8px; }
        .inp-wrap { flex: 1; background: #000; border-radius: 25px; padding: 0 15px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        #mInp { border: none; background: transparent; color: #fff; padding: 12px 0; flex: 1; outline: none; font-size: 15px; }
        
        .ghost-btn { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }
        .ghost-btn.active { background: #6366f1; box-shadow: 0 0 10px #6366f1; border-color: transparent; }

        /* MODALS */
        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; backdrop-filter: blur(5px); }
        .sheet-overlay.active { display: flex; }
        .sheet { width: 100%; background: var(--panel); border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(100%); transition: 0.3s; max-height: 85vh; overflow-y: auto; }
        .sheet-overlay.active .sheet { transform: translateY(0); }
        .sheet-btn { width: 100%; padding: 16px; background: rgba(255,255,255,0.05); border: none; color: #fff; border-radius: 15px; margin-bottom: 10px; text-align: left; display: flex; align-items: center; gap: 12px; }

        @keyframes pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <header id="appHeader">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap:10px" onclick="openSheet('settingsSheet')">
                <img id="myAva" src="">
                <div>
                    <b id="roomTitle">Qlobal √áat</b>
                    <div id="moodText" style="font-size:10px; color:var(--blue)">‚ú® Mood: Stabil</div>
                </div>
            </div>
            <div style="display:flex; gap:18px; font-size:22px">
                <span onclick="openFriends()" style="position:relative">üë•<div id="reqDot" style="display:none; width:10px; height:10px; background:red; border-radius:50%; position:absolute; top:-2px; right:-2px"></div></span>
                <span onclick="openRooms()">üè†</span>
            </div>
        </div>
    </header>

    <div id="chat"></div>

    <div id="replyBar">
        <div id="replyTxt" style="opacity:0.7"></div>
        <span onclick="cancelReply()" style="color:red; font-weight:bold">X</span>
    </div>

    <div class="footer">
        <span onclick="openSheet('attachSheet')" style="font-size:25px; color:var(--blue); cursor:pointer">+</span>
        <div class="ghost-btn" id="ghostToggle" onclick="toggleGhostMode()" title="Duman Rejimi">üëª</div>
        <div class="inp-wrap">
            <input type="text" id="mInp" placeholder="Mesaj..." onkeypress="if(event.key==='Enter') sendMsg()">
        </div>
        <button onclick="sendMsg()" style="background:var(--blue); border:none; color:#fff; width:40px; height:40px; border-radius:50%">‚û§</button>
    </div>

    <div id="roomsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Otaqlar</h3>
        <button class="sheet-btn" onclick="createRoom()" style="background:var(--blue); margin-top:15px">‚ûï Yeni ≈ûifr…ôli v…ô ya Zon Otaƒüƒ±</button>
        <div id="roomsContainer" style="margin-top:10px"></div>
    </div></div>

    <div id="friendsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Dostluq ƒ∞st…ôkl…ôri</h3>
        <div id="friendsContainer" style="margin-top:15px"></div>
    </div></div>

    <div id="attachSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="document.getElementById('fInp').click()">üñº ≈û…ôkil G√∂nd…ôr</button>
        <button class="sheet-btn" onclick="handleVoice()">üéô S…ôs Yaz</button>
        <button class="sheet-btn" onclick="sendLocation()">üìç M…ôkan Payla≈ü</button>
    </div></div>

    <div id="settingsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="logout()" style="color:red">üõë √áƒ±xƒ±≈ü</button>
    </div></div>

    <input type="file" id="fInp" hidden accept="image/*" onchange="uploadFile()">

<script>
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user'));
    let room = 'General';
    let isGhostMode = false;
    let replyTo = null;
    let myFriends = JSON.parse(localStorage.getItem('x_friends')) || [];
    let myRooms = JSON.parse(localStorage.getItem('x_rooms')) || [{name:'General'}];
    let mediaRecorder, chunks = [];

    // --- BA≈ûLANƒûIC ---
    function init() {
        if(!user) {
            const n = prompt("Adƒ±nƒ±z:");
            if(!n) return location.reload();
            user = { nick: n, ava: `https://ui-avatars.com/api/?name=${n}&background=random` };
            localStorage.setItem('x_user', JSON.stringify(user));
            location.reload();
        }
        document.getElementById('myAva').src = user.ava;
        loadMsgs();
        listenRealtime();
        updateMood(); // Mood Sync Ba≈ülat
    }

    // --- REALTIME Lƒ∞STENER ---
    function listenRealtime() {
        sb.channel('global').on('postgres_changes', {event:'*', schema:'public', table:'messages'}, p => {
            if(p.new && p.new.group_id === room) loadMsgs();
            if(p.new && p.new.group_id === 'REQ_'+user.nick) document.getElementById('reqDot').style.display='block';
        }).subscribe();
    }

    // --- MESAJ Sƒ∞STEMƒ∞ ---
    async function loadMsgs() {
        const { data } = await sb.from('messages').select('*').eq('group_id', room).order('created_at',{ascending:true});
        const chat = document.getElementById('chat'); chat.innerHTML = '';
        data.forEach(m => {
            let j = {}; try { j = JSON.parse(m.content); } catch { j = {text: m.content}; }
            const isMe = m.nickname === user.nick;
            const div = document.createElement('div');
            
            // Ghost Mesaj Yoxlamasƒ±
            const isGhost = j.mode === 'ghost';
            div.className = `msg-box ${isMe ? 'me' : 'other'} ${isGhost ? 'ghost-msg' : ''}`;
            
            let body = '';
            if(j.reply) body += `<div style="font-size:10px; opacity:0.6; border-left:2px solid var(--blue); padding-left:5px; margin-bottom:5px"><b>${j.reply.to}:</b> ${j.reply.txt}</div>`;
            if(j.type === 'audio') body += `<audio src="${j.url}" controls></audio>`;
            else if(j.type === 'image') body += `<img src="${j.url}" style="max-width:100%; border-radius:10px">`;
            else if(j.type === 'loc') body += `<a href="${j.url}" target="_blank" style="color:cyan">üìç M…ôkan</a>`;
            else body += `<div>${j.text || ''}</div>`;

            div.innerHTML = `${!isMe ? `<b style="font-size:11px; color:var(--blue)">${m.nickname}</b><br>` : ''}${body}`;
            div.onclick = () => setReply(m.nickname, j.text || "Media");
            chat.appendChild(div);

            // Ghost mesajƒ± 10 saniy…ô sonra bazadan t…ômizl…ô
            if(isGhost && isMe) {
                setTimeout(async () => { await sb.from('messages').delete().eq('id', m.id); }, 10000);
            }
        });
        chat.scrollTop = chat.scrollHeight;
    }

    async function sendMsg(extra = {}) {
        const inp = document.getElementById('mInp');
        const val = inp.value.trim(); if(!val && !extra.type) return;
        
        const payload = { text: val, ava: user.ava, mode: isGhostMode ? 'ghost' : 'normal', ...extra };
        if(replyTo) { payload.reply = replyTo; cancelReply(); }
        
        inp.value = '';
        if(isGhostMode) toggleGhostMode(); // Mesajdan sonra dumanƒ± s√∂nd√ºr

        await sb.from('messages').insert([{ nickname: user.nick, group_id: room, content: JSON.stringify(payload) }]);
    }

    // --- YENƒ∞ FUNKSƒ∞YALAR (V11) ---
    function toggleGhostMode() {
        isGhostMode = !isGhostMode;
        document.getElementById('ghostToggle').classList.toggle('active', isGhostMode);
        document.getElementById('mInp').placeholder = isGhostMode ? "Duman rejimind…ô yazƒ±lƒ±r..." : "Mesaj...";
    }

    function updateMood() {
        const hour = new Date().getHours();
        const header = document.getElementById('appHeader');
        const moodTxt = document.getElementById('moodText');
        
        if(hour >= 20 || hour < 6) {
            document.body.style.background = "#05070a";
            moodTxt.innerText = "‚ú® Mood: Gec…ô Sakitliyi";
        } else if(hour >= 6 && hour < 12) {
            moodTxt.innerText = "‚ú® Mood: S…ôh…ôr Enerjisi";
        } else {
            moodTxt.innerText = "‚ú® Mood: G√ºnorta Aktivi";
        }
    }

    // --- KLASSƒ∞K FUNKSƒ∞YALAR (QORUNANLAR) ---
    async function handleVoice() {
        const btn = document.getElementById('micBtn');
        if(!mediaRecorder || mediaRecorder.state === 'inactive') {
            const stream = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(chunks, {type:'audio/webm'});
                const name = `v_${Date.now()}`;
                await sb.storage.from('audio_messages').upload(name, blob);
                sendMsg({type:'audio', url: `${SB_URL}/storage/v1/object/public/audio_messages/${name}`});
            };
            mediaRecorder.start();
            alert("S…ôs yazƒ±lƒ±r...");
        } else { mediaRecorder.stop(); }
        closeSheets();
    }

    async function uploadFile() {
        const f = document.getElementById('fInp').files[0]; if(!f) return;
        const name = `img_${Date.now()}`;
        await sb.storage.from('audio_messages').upload(name, f);
        sendMsg({type:'image', url: `${SB_URL}/storage/v1/object/public/audio_messages/${name}`});
        closeSheets();
    }

    function sendLocation() {
        navigator.geolocation.getCurrentPosition(p => {
            sendMsg({type:'loc', url: `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`});
            closeSheets();
        });
    }

    function createRoom() {
        const n = prompt("Otaq adƒ±:"); if(!n) return;
        const p = prompt("≈ûifr…ô (yoxdursa bo≈ü qoyun):");
        const rObj = { name: n, pass: p || null };
        myRooms.push(rObj);
        localStorage.setItem('x_rooms', JSON.stringify(myRooms));
        switchRoom(rObj);
    }

    function openRooms() {
        const cont = document.getElementById('roomsContainer'); cont.innerHTML = '';
        myRooms.forEach(r => {
            cont.innerHTML += `<button class="sheet-btn" onclick='switchRoom(${JSON.stringify(r)})'>üè† ${r.name} ${r.pass ? 'üîí' : ''}</button>`;
        });
        openSheet('roomsSheet');
    }

    function switchRoom(r) {
        if(r.pass) {
            const p = prompt("≈ûifr…ô:");
            if(p !== r.pass) return alert("S…ôhv ≈üifr…ô!");
        }
        room = r.name;
        document.getElementById('roomTitle').innerText = room;
        closeSheets(); loadMsgs();
    }

    function setReply(to, txt) {
        replyTo = { to, txt };
        document.getElementById('replyTxt').innerText = to + ": " + txt;
        document.getElementById('replyBar').style.display = 'flex';
    }
    function cancelReply() { replyTo = null; document.getElementById('replyBar').style.display = 'none'; }
    function openSheet(id) { document.getElementById(id).classList.add('active'); }
    function closeSheets() { document.querySelectorAll('.sheet-overlay').forEach(s => s.classList.remove('active')); }
    function logout() { localStorage.clear(); location.reload(); }

    init();
</script>
</body>
</html>
 
