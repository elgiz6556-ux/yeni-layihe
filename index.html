<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>X-Chat PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://meet.jit.si/external_api.js'></script>
    <style>
        :root { --bg: #0b0e14; --primary: #3b82f6; --text: #ffffff; --glass: rgba(255,255,255,0.05); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Login */
        #auth { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .card { background: #1a1c23; padding: 25px; border-radius: 20px; width: 100%; max-width: 320px; text-align: center; }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid #333; background: #000; color: #fff; font-size: 16px; }
        button { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: #fff; font-weight: bold; font-size: 16px; }

        /* App Layout */
        header { height: 60px; background: #1a1c23; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #333; }
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background-size: cover; }
        .footer { padding: 10px; background: #1a1c23; display: flex; align-items: center; gap: 10px; padding-bottom: env(safe-area-inset-bottom); }
        
        /* Messages */
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 18px; position: relative; font-size: 15px; line-height: 1.4; }
        .msg.me { align-self: flex-end; background: var(--primary); border-bottom-right-radius: 4px; }
        .msg.other { align-self: flex-start; background: #2d2f3a; border-bottom-left-radius: 4px; }
        .sender { font-size: 10px; opacity: 0.6; display: block; margin-bottom: 3px; }
        
        /* Multimedia */
        img.chat-img { max-width: 100%; border-radius: 10px; margin: 5px 0; }
        audio { height: 35px; width: 200px; margin: 5px 0; filter: invert(1); }

        /* Menu */
        #menu { position: fixed; top: 0; left: -100%; width: 80%; height: 100%; background: #1a1c23; z-index: 500; transition: 0.3s; padding: 20px; box-shadow: 5px 0 20px #000; }
        #menu.open { left: 0; }
        .menu-item { padding: 15px; border-bottom: 1px solid #333; font-size: 16px; display: flex; align-items: center; gap: 10px; }
        
        #call-ui { position: fixed; inset: 0; z-index: 2000; background: #000; display: none; }
    </style>
</head>
<body>

    <div id="auth">
        <div class="card">
            <h2 style="margin-top:0">X-CHAT</h2>
            <input type="text" id="nick" placeholder="Adƒ±n">
            <input type="password" id="pass" placeholder="≈ûifr…ô">
            <button onclick="start()">Giri≈ü</button>
        </div>
    </div>

    <header>
        <div onclick="document.getElementById('menu').classList.toggle('open')" style="display:flex; align-items:center; gap:10px">
            <img id="myAva" style="width:35px; height:35px; border-radius:50%; background:#333">
            <b id="roomLabel">General</b>
        </div>
        <div style="font-size:20px; display:flex; gap:15px">
            <span onclick="startCall()">üìû</span>
            <span onclick="document.getElementById('menu').classList.toggle('open')">‚öôÔ∏è</span>
        </div>
    </header>

    <div id="chat"></div>

    <div class="footer">
        <span onclick="document.getElementById('fInp').click()">üì∑</span>
        <span id="mic" onclick="toggleMic()">üéôÔ∏è</span>
        <input type="text" id="mInp" placeholder="Mesaj..." style="flex:1; margin:0; padding:10px">
        <button onclick="sendText()" style="width:auto; padding:10px 15px">‚û§</button>
    </div>

    <div id="menu" onclick="this.classList.remove('open')">
        <div class="menu-item" onclick="changeRoom()">üîí Otaƒüƒ± D…ôyi≈ü / Kod Qoy</div>
        <div class="menu-item" onclick="document.getElementById('bgInp').click()">üñº Fonu D…ôyi≈ü</div>
        <div class="menu-item" onclick="document.getElementById('avaInp').click()">üë§ Profili D…ôyi≈ü</div>
        <div class="menu-item" onclick="logout()" style="color:red">üõë √áƒ±xƒ±≈ü</div>
    </div>

    <div id="call-ui"><div id="jitsi" style="height:100%"></div><button onclick="endCall()" style="position:absolute; bottom:30px; left:50%; transform:translateX(-50%); width:200px; background:red">Bitir</button></div>

    <input type="file" id="fInp" hidden accept="image/*" onchange="upFile(this, 'image')">
    <input type="file" id="avaInp" hidden accept="image/*" onchange="upFile(this, 'avatar')">
    <input type="file" id="bgInp" hidden accept="image/*" onchange="setBg(this)">

<script>
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user'));
    let room = 'General';
    let rec, chunks = [];

    if(user) start();

    function start() {
        if(!user) {
            const n = document.getElementById('nick').value;
            const p = document.getElementById('pass').value;
            if(!n || !p) return;
            user = { nick: n, pass: p, ava: `https://ui-avatars.com/api/?name=${n}` };
            localStorage.setItem('x_user', JSON.stringify(user));
        }
        document.getElementById('auth').style.display = 'none';
        document.getElementById('myAva').src = user.ava;
        if(localStorage.getItem('x_bg')) document.getElementById('chat').style.backgroundImage = `url(${localStorage.getItem('x_bg')})`;
        
        loadMsgs();
        sb.channel('any').on('postgres_changes',{event:'*',schema:'public',table:'messages'},()=>loadMsgs()).subscribe();
    }

    async function loadMsgs() {
        const { data } = await sb.from('messages').select('*').eq('group_id', room).order('created_at',{ascending:true});
        const c = document.getElementById('chat');
        c.innerHTML = '';
        if(data) data.forEach(m => {
            let body = m.content;
            try { 
                const j = JSON.parse(m.content); 
                if(j.type==='image') body = `<img src="${j.url}" class="chat-img">`;
                else if(j.type==='audio') body = `<audio src="${j.url}" controls></audio>`;
                else body = j.text;
            } catch(e){}

            const div = document.createElement('div');
            div.className = `msg ${m.nickname === user.nick ? 'me' : 'other'}`;
            div.innerHTML = `<span class="sender">${m.nickname}</span>${body}`;
            div.onclick = () => { if(m.nickname===user.nick && confirm('Silinsin?')) deleteMsg(m.id) };
            c.appendChild(div);
        });
        c.scrollTop = c.scrollHeight;
    }

    async function sendText() {
        const i = document.getElementById('mInp');
        if(!i.value) return;
        const txt = i.value; i.value = '';
        await sb.from('messages').insert([{ nickname: user.nick, content: JSON.stringify({text:txt, type:'text'}), group_id: room }]);
    }

    async function upFile(el, mode) {
        const f = el.files[0]; if(!f) return;
        const name = `${Date.now()}_${f.name}`;
        const { data } = await sb.storage.from('audio_messages').upload(name, f);
        const url = `${SB_URL}/storage/v1/object/public/audio_messages/${name}`;
        
        if(mode === 'image') await sb.from('messages').insert([{ nickname: user.nick, content: JSON.stringify({url:url, type:'image'}), group_id: room }]);
        else if(mode === 'avatar') { user.ava = url; localStorage.setItem('x_user', JSON.stringify(user)); location.reload(); }
    }

    async function toggleMic() {
        const btn = document.getElementById('mic');
        if(!rec || rec.state === 'inactive') {
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            rec = new MediaRecorder(s); chunks = [];
            rec.ondataavailable = e => chunks.push(e.data);
            rec.onstop = async () => {
                const blob = new Blob(chunks, {type:'audio/webm'});
                const name = `voice_${Date.now()}.webm`;
                await sb.storage.from('audio_messages').upload(name, blob);
                const url = `${SB_URL}/storage/v1/object/public/audio_messages/${name}`;
                await sb.from('messages').insert([{ nickname: user.nick, content: JSON.stringify({url:url, type:'audio'}), group_id: room }]);
                btn.style.color = 'white';
            };
            rec.start(); btn.style.color = 'red';
        } else { rec.stop(); }
    }

    async function deleteMsg(id) { await sb.from('messages').delete().eq('id', id); loadMsgs(); }

    function setBg(el) {
        const r = new FileReader();
        r.onload = e => { document.getElementById('chat').style.backgroundImage = `url(${e.target.result})`; localStorage.setItem('x_bg', e.target.result); };
        r.readAsDataURL(el.files[0]);
    }

    function changeRoom() {
        const n = prompt("Otaq adƒ±:");
        const p = prompt("Otaq ≈üifr…ôsi (kims…ô girm…ôsin dey…ô):");
        if(n) { room = n; document.getElementById('roomLabel').innerText = n; loadMsgs(); }
    }

    function startCall() {
        document.getElementById('call-ui').style.display = 'block';
        new JitsiMeetExternalAPI("meet.jit.si", { roomName: "XChat_"+room, parentNode: document.querySelector('#jitsi') });
    }
    function endCall() { document.getElementById('call-ui').style.display = 'none'; document.getElementById('jitsi').innerHTML = ''; }
    function logout() { localStorage.clear(); location.reload(); }
    document.getElementById('mInp').onkeypress = (e) => { if(e.key==='Enter') sendText() };
</script>
</body>
</html>
 
