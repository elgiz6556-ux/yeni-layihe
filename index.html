<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>X-Chat V10 THE ONE</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0b0d10; --panel: #16191f; --blue: #3b82f6; --me: #2b5278; --other: #1c2128; --text: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { background: var(--panel); padding: 45px 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 100; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-info img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--blue); object-fit: cover; }
        .search-wrap { margin-top: 10px; display: none; }
        .search-wrap.active { display: block; }
        input.search-inp { width: 100%; background: #000; border: none; padding: 10px; border-radius: 10px; color: #fff; font-size: 13px; outline: none; }

        /* CHAT AREA */
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .msg-box { max-width: 82%; padding: 10px 14px; border-radius: 18px; position: relative; font-size: 15px; line-height: 1.4; animation: pop 0.2s ease-out; word-wrap: break-word; }
        .me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; background: var(--other); border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }
        .reply-box { font-size: 11px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 8px; margin-bottom: 5px; border-left: 3px solid var(--blue); }
        @keyframes pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* FOOTER & REPLIES */
        #replyBar { display: none; background: #000; padding: 10px 15px; border-top: 2px solid var(--blue); font-size: 12px; justify-content: space-between; }
        .footer { background: var(--panel); padding: 10px 10px 35px; display: flex; align-items: center; gap: 10px; }
        .inp-wrap { flex: 1; background: #000; border-radius: 25px; padding: 0 15px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        #mInp { border: none; background: transparent; color: #fff; padding: 12px 0; flex: 1; outline: none; font-size: 15px; }

        /* MODALS */
        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; backdrop-filter: blur(5px); }
        .sheet-overlay.active { display: flex; }
        .sheet { width: 100%; background: var(--panel); border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(100%); transition: 0.3s; max-height: 85vh; overflow-y: auto; }
        .sheet-overlay.active .sheet { transform: translateY(0); }
        .sheet-btn { width: 100%; padding: 16px; background: rgba(255,255,255,0.05); border: none; color: #fff; border-radius: 15px; margin-bottom: 10px; text-align: left; font-size: 15px; display: flex; align-items: center; gap: 12px; }

        /* UTILS */
        .req-dot { width: 10px; height: 10px; background: #ef4444; border-radius: 50%; position: absolute; top: -2px; right: -2px; border: 2px solid var(--panel); display: none; }
        .rec-active { color: #ef4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        audio { width: 220px; height: 40px; filter: invert(1); margin-top: 5px; }
        img.msg-img { max-width: 100%; border-radius: 12px; margin-top: 8px; }
        
        #loginPage { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; align-items: center; justify-content: center; padding: 30px; }
        .card { background: var(--panel); width: 100%; max-width: 380px; padding: 30px; border-radius: 30px; text-align: center; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="card">
            <h1 style="color:var(--blue); margin-bottom:20px">X-Chat V10</h1>
            <div id="avaBox" style="width:80px; height:80px; border-radius:50%; background:#000; margin:0 auto 20px; border:2px dashed var(--blue); display:flex; align-items:center; justify-content:center; overflow:hidden; cursor:pointer" onclick="document.getElementById('avaFile').click()">
                <img id="avaPrev" style="width:100%; height:100%; object-fit:cover; display:none">
                <span id="avaPlus" style="font-size:30px">üì∏</span>
            </div>
            <input type="file" id="avaFile" hidden accept="image/*" onchange="previewAva()">
            <input type="text" id="nickInp" style="width:100%; background:#000; border:1px solid rgba(255,255,255,0.1); color:#fff; padding:15px; border-radius:15px; margin-bottom:15px; outline:none" placeholder="L…ôq…ôbiniz">
            <button onclick="handleLogin()" style="width:100%; padding:15px; background:var(--blue); border:none; color:#fff; border-radius:15px; font-weight:bold">Daxil Ol</button>
        </div>
    </div>

    <div id="mainApp" style="display:none; height:100%; flex-direction:column">
        <header>
            <div class="top-bar">
                <div class="user-info" onclick="openSheet('settingsSheet')">
                    <img id="myAva" src="">
                    <div>
                        <b id="roomTitle">Qlobal √áat</b>
                        <div style="font-size:10px; color:#10b981">‚óè Online</div>
                    </div>
                </div>
                <div style="display:flex; gap:18px; font-size:22px; align-items:center">
                    <span onclick="toggleSearch()">üîç</span>
                    <span onclick="openFriends()" style="position:relative">üë•<div id="reqDot" class="req-dot"></div></span>
                    <span onclick="openRooms()">üè†</span>
                </div>
            </div>
            <div class="search-wrap" id="searchWrap">
                <input type="text" class="search-inp" id="searchInp" placeholder="Mesajlarda axtar..." oninput="searchMsgs()">
            </div>
        </header>

        <div id="chat"></div>

        <div id="replyBar">
            <div id="replyTxt" style="opacity:0.7"></div>
            <span onclick="cancelReply()" style="color:#ef4444; font-weight:bold; cursor:pointer">X</span>
        </div>

        <div class="footer">
            <span onclick="openSheet('attachSheet')" style="font-size:26px; color:var(--blue); cursor:pointer">+</span>
            <span id="micBtn" onclick="handleVoice()" style="font-size:22px; cursor:pointer">üéô</span>
            <div class="inp-wrap">
                <input type="text" id="mInp" placeholder="Mesaj yaz..." onkeypress="if(event.key==='Enter') sendMsg()">
            </div>
            <button onclick="sendMsg()" style="background:var(--blue); border:none; color:#fff; width:42px; height:42px; border-radius:50%; font-size:18px">‚û§</button>
        </div>
    </div>

    <div id="roomsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Otaqlar</h3>
        <button class="sheet-btn" onclick="createRoom()" style="background:var(--blue); font-weight:bold; margin-top:15px">‚ûï Yeni ≈ûifr…ôli Otaq</button>
        <div id="roomsContainer" style="margin-top:10px"></div>
    </div></div>

    <div id="friendsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Dostlar & ƒ∞st…ôkl…ôr</h3>
        <div id="friendsContainer" style="margin-top:15px"></div>
    </div></div>

    <div id="attachSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <button class="sheet-btn" onclick="document.getElementById('fInp').click()">üñº ≈û…ôkil G√∂nd…ôr</button>
        <button class="sheet-btn" onclick="sendLocation()">üìç Konum Payla≈ü</button>
    </div></div>

    <div id="settingsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="switchRoom({name:'General'})">üåç Qlobal √áata D√∂n</button>
        <button class="sheet-btn" onclick="logout()" style="color:#ef4444">üõë Hesabdan √áƒ±x</button>
    </div></div>

    <div id="profileSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <div style="text-align:center; margin-bottom:20px">
            <img id="pAva" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--blue)">
            <h2 id="pNick" style="margin-top:10px"></h2>
        </div>
        <button class="sheet-btn" id="dmBtn" style="background:var(--blue); justify-content:center">üí¨ DM Yaz</button>
        <button class="sheet-btn" id="addFBtn" style="justify-content:center; border:1px solid var(--blue)">ü§ù Dostluq At</button>
    </div></div>

    <input type="file" id="fInp" hidden accept="image/*" onchange="uploadFile()">

<script>
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user'));
    let room = 'General';
    let myFriends = JSON.parse(localStorage.getItem('x_friends')) || [];
    let myRooms = JSON.parse(localStorage.getItem('x_rooms')) || [{name:'General'}];
    let replyTo = null, allMsgs = [], mediaRecorder, chunks = [], uploadedAva = "";

    if (Notification.permission !== "granted") Notification.requestPermission();

    function checkLogin() {
        if(user) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            document.getElementById('myAva').src = user.ava;
            loadMsgs();
            fetchReqs();
            sb.channel('updates').on('postgres_changes',{event:'*',schema:'public',table:'messages'}, p => {
                if(p.new.group_id === room) loadMsgs();
                if(p.new.group_id === 'REQ_'+user.nick) { fetchReqs(); notify("Yeni ƒ∞st…ôk!", "Biri s…ôn…ô dostluq atdƒ±."); }
                if(p.new.group_id.startsWith('DM_') && p.new.nickname !== user.nick) notify("Yeni Mesaj!", p.new.nickname + " yazdƒ±.");
            }).subscribe();
        }
    }

    async function previewAva() {
        const file = document.getElementById('avaFile').files[0];
        const name = `ava_${Date.now()}.png`;
        await sb.storage.from('audio_messages').upload(name, file);
        uploadedAva = `${SB_URL}/storage/v1/object/public/audio_messages/${name}`;
        document.getElementById('avaPrev').src = uploadedAva;
        document.getElementById('avaPrev').style.display = 'block';
        document.getElementById('avaPlus').style.display = 'none';
    }

    function handleLogin() {
        const n = document.getElementById('nickInp').value.trim();
        if(!n) return;
        user = { nick: n, ava: uploadedAva || `https://ui-avatars.com/api/?name=${n}` };
        localStorage.setItem('x_user', JSON.stringify(user));
        location.reload();
    }

    async function loadMsgs() {
        const { data } = await sb.from('messages').select('*').eq('group_id', room).order('created_at',{ascending:true});
        allMsgs = data; renderMsgs(data);
    }

    function renderMsgs(data) {
        const chat = document.getElementById('chat'); chat.innerHTML = '';
        data.forEach(m => {
            const isMe = m.nickname === user.nick;
            let j = {}; try { j = JSON.parse(m.content); } catch { j = {text:m.content}; }
            const div = document.createElement('div');
            div.className = `msg-box ${isMe ? 'me' : 'other'}`;
            div.onclick = () => setReply(m.nickname, j.text || "Media");

            let body = '';
            if(j.reply) body += `<div class="reply-box"><b>${j.reply.to}:</b> ${j.reply.txt}</div>`;
            if(j.type === 'audio') body += `<audio src="${j.url}" controls></audio>`;
            else if(j.type === 'image') body += `<img src="${j.url}" class="msg-img">`;
            else if(j.type === 'loc') body += `<a href="${j.url}" target="_blank" style="color:cyan">üìç M…ôkan</a>`;
            else body += `<div>${j.text || ''}</div>`;

            div.innerHTML = `${!isMe ? `<b onclick="openProfile('${m.nickname}','${j.ava}')" style="font-size:11px; color:var(--blue); cursor:pointer">${m.nickname}</b><br>` : ''}${body}`;
            chat.appendChild(div);
        });
        chat.scrollTop = chat.scrollHeight;
    }

    async function sendMsg(extra = {}) {
        const inp = document.getElementById('mInp');
        const val = inp.value.trim(); if(!val && !extra.type) return;
        const payload = { text: val, ava: user.ava, ...extra };
        if(replyTo) { payload.reply = replyTo; cancelReply(); }
        inp.value = '';
        await sb.from('messages').insert([{ nickname: user.nick, group_id: room, content: JSON.stringify(payload) }]);
    }

    // FUNKSƒ∞YALAR
    function setReply(to, txt) { 
        replyTo = {to, txt}; 
        document.getElementById('replyTxt').innerText = to + ": " + txt;
        document.getElementById('replyBar').style.display = 'flex';
    }
    function cancelReply() { replyTo = null; document.getElementById('replyBar').style.display = 'none'; }
    
    function toggleSearch() { document.getElementById('searchWrap').classList.toggle('active'); }
    function searchMsgs() {
        const t = document.getElementById('searchInp').value.toLowerCase();
        const f = allMsgs.filter(m => m.content.toLowerCase().includes(t));
        renderMsgs(f);
    }

    async function handleVoice() {
        const btn = document.getElementById('micBtn');
        if(!mediaRecorder || mediaRecorder.state === 'inactive') {
            const stream = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(chunks, {type:'audio/webm'});
                const name = `v_${Date.now()}.webm`;
                await sb.storage.from('audio_messages').upload(name, blob);
                sendMsg({type:'audio', url: `${SB_URL}/storage/v1/object/public/audio_messages/${name}`});
                btn.classList.remove('rec-active');
            };
            mediaRecorder.start(); btn.classList.add('rec-active');
        } else mediaRecorder.stop();
    }

    async function uploadFile() {
        const f = document.getElementById('fInp').files[0]; if(!f) return;
        const name = `img_${Date.now()}`;
        await sb.storage.from('audio_messages').upload(name, f);
        sendMsg({type:'image', url: `${SB_URL}/storage/v1/object/public/audio_messages/${name}`});
        closeSheets();
    }

    function sendLocation() {
        navigator.geolocation.getCurrentPosition(p => {
            sendMsg({type:'loc', url: `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`});
            closeSheets();
        });
    }

    // SOSƒ∞AL & OTAQLAR
    function openProfile(n, a) {
        document.getElementById('pNick').innerText = n;
        document.getElementById('pAva').src = a;
        document.getElementById('dmBtn').onclick = () => {
            switchRoom({name: 'DM_' + [user.nick, n].sort().join('_')});
        };
        document.getElementById('addFBtn').onclick = () => {
            sb.from('messages').insert([{nickname:user.nick, group_id:'REQ_'+n, content:JSON.stringify({type:'req', from:user.nick, ava:user.ava})}]).then(()=>alert("G√∂nd…ôrildi"));
        };
        openSheet('profileSheet');
    }

    async function fetchReqs() {
        const { data } = await sb.from('messages').select('*').eq('group_id', 'REQ_'+user.nick);
        document.getElementById('reqDot').style.display = data.length > 0 ? 'block' : 'none';
        window.pending = data;
    }

    function openFriends() {
        const cont = document.getElementById('friendsContainer');
        cont.innerHTML = '<h4>ƒ∞st…ôkl…ôr</h4>';
        window.pending.forEach(r => {
            const d = JSON.parse(r.content);
            cont.innerHTML += `<div class="sheet-btn" style="justify-content:space-between">
                <span>${d.from}</span>
                <button onclick="acceptF('${r.id}','${d.from}','${d.ava}')" style="background:green; color:white; border:none; padding:5px 10px; border-radius:10px">Q…ôbul</button>
            </div>`;
        });
        cont.innerHTML += '<h4 style="margin-top:20px">Dostlar</h4>';
        myFriends.forEach(f => {
            cont.innerHTML += `<div class="sheet-btn" onclick="openProfile('${f.nick}','${f.ava}')">üë§ ${f.nick}</div>`;
        });
        openSheet('friendsSheet');
    }

    async function acceptF(id, n, a) {
        myFriends.push({nick:n, ava:a});
        localStorage.setItem('x_friends', JSON.stringify(myFriends));
        await sb.from('messages').delete().eq('id', id);
        fetchReqs(); openFriends();
    }

    function createRoom() {
        const n = prompt("Otaq adƒ±:"); if(!n) return;
        const p = prompt("≈ûifr…ô (opsional):");
        const rObj = {name:n, pass:p||null};
        myRooms.push(rObj);
        localStorage.setItem('x_rooms', JSON.stringify(myRooms));
        switchRoom(rObj);
    }

    function openRooms() {
        const cont = document.getElementById('roomsContainer'); cont.innerHTML = '';
        myRooms.forEach(r => {
            cont.innerHTML += `<button class="sheet-btn" onclick='switchRoom(${JSON.stringify(r)})'>üè† ${r.name} ${r.pass?'üîí':''}</button>`;
        });
        openSheet('roomsSheet');
    }

    function switchRoom(r) {
        if(r.pass) {
            const p = prompt("≈ûifr…ô:");
            if(p !== r.pass) return alert("S…ôhv ≈üifr…ô!");
        }
        room = r.name;
        document.getElementById('roomTitle').innerText = room.startsWith('DM_') ? 'üë§ ≈û…ôxsi' : room;
        closeSheets(); loadMsgs();
    }

    function notify(t, b) { if(Notification.permission==="granted") new Notification(t, {body:b}); }
    function openSheet(id) { document.getElementById(id).classList.add('active'); }
    function closeSheets() { document.querySelectorAll('.sheet-overlay').forEach(s => s.classList.remove('active')); }
    function logout() { localStorage.clear(); location.reload(); }

    checkLogin();
</script>
</body>
</html>
 
