<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X-Chat Neon</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --accent: #00d2ff; --bg: #05070a; --glass: rgba(255, 255, 255, 0.07); }
        body { 
            margin: 0; font-family: 'Segoe UI', sans-serif; 
            background: radial-gradient(circle at top, #1a1a2e, #05070a); 
            color: #fff; height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* Glass Header */
        .header { 
            padding: 15px; background: var(--glass); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;
        }
        .avatar { width: 45px; height: 45px; border-radius: 15px; border: 2px solid var(--accent); object-fit: cover; cursor: pointer; box-shadow: 0 0 10px var(--accent); }

        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Glowing Messages */
        .msg { 
            max-width: 75%; padding: 12px 16px; border-radius: 18px; background: var(--glass);
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
            animation: slideUp 0.3s ease-out; position: relative;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg.my { 
            align-self: flex-end; background: linear-gradient(135deg, var(--accent), #0072ff); 
            color: #000; font-weight: bold; box-shadow: 0 0 20px rgba(0, 210, 255, 0.4); 
        }
        .msg b { display: block; font-size: 10px; opacity: 0.7; margin-bottom: 5px; text-transform: uppercase; }

        /* Floating Input Bar */
        .input-area { padding: 20px; background: transparent; }
        .input-bar { 
            background: rgba(255,255,255,0.1); backdrop-filter: blur(25px); padding: 10px 20px; 
            border-radius: 40px; border: 1px solid rgba(255,255,255,0.2); display: flex; gap: 12px; align-items: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.7);
        }
        input { flex: 1; background: transparent; border: none; color: #fff; outline: none; font-size: 16px; }
        .btn-send { background: var(--accent); border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 20px; box-shadow: 0 0 15px var(--accent); }

        #typing { font-size: 12px; color: var(--accent); position: absolute; top: 75px; left: 20px; font-style: italic; }
        audio { filter: invert(1); width: 220px; height: 40px; }
    </style>
</head>
<body>

<div class="header">
    <img id="myAvatar" class="avatar" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" onclick="changeAvatar()">
    <div style="text-align: center;">
        <div style="font-weight: bold; letter-spacing: 3px; font-size: 20px;">X-CHAT</div>
        <div style="font-size: 10px; color: var(--accent);">PREMIUM EDITION</div>
    </div>
    <button onclick="location.reload()" style="background:none; border:none; color:white; font-size:22px; cursor:pointer;">ðŸ”„</button>
</div>

<div id="typing"></div>
<div id="chat"></div>

<div class="input-area">
    <div class="input-bar">
        <button onclick="doVoice()" id="mic" style="background:none; border:none; color:white; font-size:22px; cursor:pointer;">ðŸŽ¤</button>
        <input type="text" id="msgInp" placeholder="MesajÄ±nÄ±zÄ± bura yazÄ±n..." oninput="isTyping()" onkeypress="if(event.key=='Enter') doSend()">
        <button class="btn-send" onclick="doSend()">ðŸš€</button>
    </div>
</div>

<script>
    const supabaseUrl = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const _sb = supabase.createClient(supabaseUrl, supabaseKey);

    let user = {
        nick: localStorage.getItem('chat_nick') || prompt("AdÄ±nÄ±z:"),
        avatar: localStorage.getItem('chat_avatar') || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'
    };
    localStorage.setItem('chat_nick', user.nick);
    document.getElementById('myAvatar').src = user.avatar;

    // Presence & Typing
    const channel = _sb.channel('room1');
    channel.on('broadcast', { event: 'typing' }, p => {
        const t = document.getElementById('typing');
        t.innerText = p.payload.nick + " yazÄ±r...";
        setTimeout(() => t.innerText = "", 2000);
    }).subscribe();

    function isTyping() {
        channel.send({ type: 'broadcast', event: 'typing', payload: { nick: user.nick } });
    }

    // Realtime Database
    _sb.channel('db').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => render(p.new)).subscribe();

    async function doSend() {
        const inp = document.getElementById('msgInp');
        if (!inp.value.trim()) return;
        const val = inp.value; inp.value = '';
        await _sb.from('messages').insert([{ content: val, nickname: user.nick, sender_avatar: user.avatar }]);
    }

    function render(m) {
        if(document.getElementById('m-'+m.id)) return;
        const isMy = m.nickname === user.nick;
        const d = document.createElement('div');
        d.id = 'm-'+m.id;
        d.className = `msg ${isMy ? 'my' : ''}`;
        
        let content = m.content;
        if(content.includes('audio_messages')) content = `<audio src="${content}" controls></audio>`;

        d.innerHTML = `<b>${m.nickname}</b>${content}`;
        document.getElementById('chat').appendChild(d);
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    async function load() {
        const { data } = await _sb.from('messages').select('*').order('created_at', { ascending: true });
        if(data) data.forEach(render);
    }

    function changeAvatar() {
        const link = prompt("Avatar URL:");
        if(link) {
            user.avatar = link;
            localStorage.setItem('chat_avatar', link);
            document.getElementById('myAvatar').src = link;
        }
    }

    let rec, chunks = [];
    async function doVoice() {
        const m = document.getElementById('mic');
        if (!rec || rec.state === "inactive") {
            const s = await navigator.mediaDevices.getUserMedia({ audio: true });
            rec = new MediaRecorder(s);
            chunks = [];
            rec.onstart = () => m.style.color = "red";
            rec.onstop = async () => {
                m.style.color = "white";
                const b = new Blob(chunks, { type: 'audio/webm' });
                const fn = `v_${Date.now()}.webm`;
                const { data } = await _sb.storage.from('audio_messages').upload(fn, b);
                if(data) {
                    const url = `${supabaseUrl}/storage/v1/object/public/audio_messages/${fn}`;
                    await _sb.from('messages').insert([{ content: url, nickname: user.nick, sender_avatar: user.avatar }]);
                }
            };
            rec.ondataavailable = e => chunks.push(e.data);
            rec.start();
        } else { rec.stop(); }
    }

    load();
</script>
</body>
</html>
