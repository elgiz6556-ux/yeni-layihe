<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-Chat Final</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0d1117; --accent: #58a6ff; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: #fff; height: 100dvh; display: flex; flex-direction: column; }
        .header { padding: 15px; background: #161b22; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #30363d; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--accent); cursor: pointer; object-fit: cover; }
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 12px; background: #21262d; position: relative; }
        .msg.my { align-self: flex-end; background: var(--accent); color: #000; }
        .input-bar { padding: 15px; background: #161b22; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; background: #0d1117; border: 1px solid #30363d; padding: 12px; border-radius: 20px; color: #fff; }
    </style>
</head>
<body>

<div class="header">
    <img id="myAvatar" class="avatar" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" onclick="setupProfile()">
    <div id="roomInfo">General Qrupu</div>
    <button onclick="location.reload()" style="background:none; border:none; color:white; font-size:20px;">ðŸ”„</button>
</div>

<div id="chat"></div>

<div class="input-bar">
    <button onclick="toggleVoice()" id="mic" style="font-size:20px; background:none; border:none; color:white;">ðŸŽ¤</button>
    <input type="text" id="msgInp" placeholder="Mesaj..." onkeypress="if(event.key=='Enter') send()">
    <button onclick="send()" style="background:var(--accent); border:none; padding:10px 20px; border-radius:20px; font-weight:bold;">GÃ¶nder</button>
</div>

<script>
    const _sb = supabase.createClient('https://pyknspxnwnilhqsazidj.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU');

    let user = {
        nick: localStorage.getItem('chat_nick') || prompt("AdÄ±n:"),
        avatar: localStorage.getItem('chat_avatar') || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'
    };
    localStorage.setItem('chat_nick', user.nick);
    document.getElementById('myAvatar').src = user.avatar;

    // REALTIME AKTÄ°VASYON
    _sb.channel('any').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
        render(p.new);
    }).subscribe();

    async function send() {
        const i = document.getElementById('msgInp');
        if (!i.value.trim()) return;
        await _sb.from('messages').insert([{ 
            content: i.value, 
            nickname: user.nick, 
            sender_avatar: user.avatar 
        }]);
        i.value = '';
    }

    function render(m) {
        if(document.getElementById('m-'+m.id)) return;
        const isMy = m.nickname === user.nick;
        const d = document.createElement('div');
        d.id = 'm-'+m.id;
        d.className = `msg ${isMy ? 'my' : ''}`;
        d.innerHTML = `<img src="${m.sender_avatar}" style="width:20px; height:20px; border-radius:50%"> <b>${m.nickname}:</b><br>${m.content}`;
        document.getElementById('chat').appendChild(d);
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    function setupProfile() {
        const link = prompt("Profil ÅŸÉ™kli Ã¼Ã§Ã¼n bir link yapÄ±ÅŸdÄ±rÄ±n (mÉ™s: https://sayt.com/sekil.jpg):");
        if(link) {
            user.avatar = link;
            localStorage.setItem('chat_avatar', link);
            document.getElementById('myAvatar').src = link;
            alert("Profil ÅŸÉ™kli yenilÉ™ndi! Ä°ndi mesaj yazaraq yoxla.");
        }
    }

    _sb.from('messages').select('*').order('created_at', { ascending: true }).then(({data}) => data && data.forEach(render));
</script>
</body>
</html>
