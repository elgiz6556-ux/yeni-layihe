<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>X-Chat V14 FIX</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0b0d10; --panel: #16191f; --blue: #3b82f6; --me: #2b5278; --other: #1c2128; --text: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        header { background: var(--panel); padding: 45px 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--blue); object-fit: cover; }

        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg-box { max-width: 82%; padding: 10px 14px; border-radius: 18px; position: relative; font-size: 15px; animation: pop 0.2s ease-out; }
        .me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; background: var(--other); border-bottom-left-radius: 4px; }

        .footer { background: var(--panel); padding: 10px 10px 35px; display: flex; align-items: center; gap: 10px; }
        .inp-wrap { flex: 1; background: #000; border-radius: 25px; padding: 0 15px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        #mInp { border: none; background: transparent; color: #fff; padding: 12px 0; flex: 1; outline: none; }

        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; backdrop-filter: blur(5px); }
        .sheet-overlay.active { display: flex; }
        .sheet { width: 100%; background: var(--panel); border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(100%); transition: 0.3s; max-height: 85vh; overflow-y: auto; }
        .sheet-overlay.active .sheet { transform: translateY(0); }
        
        .sheet-btn { width: 100%; padding: 15px; background: rgba(255,255,255,0.05); border: none; color: #fff; border-radius: 15px; margin-bottom: 10px; text-align: left; display: flex; align-items: center; gap: 10px; }
        @keyframes pop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <header>
        <div class="top-bar">
            <div class="user-info" onclick="openSheet('profileEditSheet')">
                <img id="headAva" src="">
                <div><b id="roomTitle">Qlobal √áat</b><div style="font-size:10px; color:#10b981">‚óè Online</div></div>
            </div>
            <div style="display:flex; gap:15px; font-size:22px">
                <span onclick="renderRooms()">üè†</span>
            </div>
        </div>
    </header>

    <div id="chat"></div>

    <div class="footer">
        <span onclick="openSheet('attachSheet')" style="font-size:25px; color:var(--blue); cursor:pointer">+</span>
        <div class="inp-wrap"><input type="text" id="mInp" placeholder="Mesaj..." onkeypress="if(event.key==='Enter') sendMsg()"></div>
        <button onclick="sendMsg()" style="background:var(--blue); border:none; color:#fff; width:40px; height:40px; border-radius:50%">‚û§</button>
    </div>

    <div id="roomsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Otaqlar</h3>
        <button class="sheet-btn" onclick="createNewRoomUI()" style="background:var(--blue); font-weight:bold">‚ûï Yeni Otaq Yarat</button>
        <div id="roomsList" style="margin-top:10px"></div>
    </div></div>

    <div id="profileEditSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Profil Ayarlarƒ±</h3>
        <button class="sheet-btn" onclick="logout()" style="color:red">üõë Hesabdan √áƒ±x</button>
    </div></div>

    <div id="attachSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="sendLocation()">üìç M…ôkan Payla≈ü</button>
    </div></div>

<script>
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user'));
    let currentRoomName = 'General';
    let myRooms = JSON.parse(localStorage.getItem('x_rooms')) || [{ name: 'General' }];

    if(!user) {
        let n = prompt("L…ôq…ôbiniz:");
        user = { nick: n || 'Qonaq', ava: `https://ui-avatars.com/api/?name=${n}` };
        localStorage.setItem('x_user', JSON.stringify(user));
        location.reload();
    }

    function init() {
        document.getElementById('headAva').src = user.ava;
        loadMsgs();
        sb.channel('updates').on('postgres_changes', {event:'*', schema:'public', table:'messages'}, () => loadMsgs()).subscribe();
    }

    async function loadMsgs() {
        const { data } = await sb.from('messages').select('*').eq('group_id', currentRoomName).order('created_at', {ascending:true});
        const chat = document.getElementById('chat'); chat.innerHTML = '';
        data.forEach(m => {
            let j = {}; try { j = JSON.parse(m.content); } catch { j = {text: m.content}; }
            const isMe = m.nickname === user.nick;
            const div = document.createElement('div');
            div.className = `msg-box ${isMe ? 'me' : 'other'}`;
            div.innerHTML = `${!isMe ? `<b style="font-size:11px; color:var(--blue)">${m.nickname}</b><br>` : ''}${j.text || ''}`;
            chat.appendChild(div);
        });
        chat.scrollTop = chat.scrollHeight;
    }

    async function sendMsg() {
        const inp = document.getElementById('mInp');
        if(!inp.value) return;
        const payload = { text: inp.value };
        await sb.from('messages').insert([{ nickname: user.nick, group_id: currentRoomName, content: JSON.stringify(payload) }]);
        inp.value = '';
    }

    // --- T∆èMƒ∞R EDƒ∞LMƒ∞≈û OTAQ Sƒ∞STEMƒ∞ ---
    function createNewRoomUI() {
        const name = prompt("Otaq adƒ± n…ô olsun?"); if(!name) return;
        
        const isZone = confirm("Bu otaq M∆èKAN Kƒ∞Lƒ∞DLƒ∞ olsun? (Yalnƒ±z sizin yaxƒ±nƒ±nƒ±zda olanlar gir…ô bil…ôc…ôk)");
        let pass = prompt("Otaq √º√ß√ºn ≈üifr…ô t…ôyin edin (≈ûifr…ôsiz ist…ôyirsinizs…ô bo≈ü qoyun):");
        
        if(isZone) {
            alert("Koordinatlarƒ±nƒ±z alƒ±nƒ±r, z…ôhm…ôt olmasa icaz…ô verin...");
            navigator.geolocation.getCurrentPosition(pos => {
                const newR = { 
                    name: name, 
                    lat: pos.coords.latitude, 
                    lng: pos.coords.longitude, 
                    isZone: true,
                    pass: pass || null 
                };
                myRooms.push(newR);
                saveRooms();
                alert("M…ôkan …ôsaslƒ± otaq yaradƒ±ldƒ±!");
                enterRoom(newR);
            }, (err) => alert("GPS x…ôtasƒ±: " + err.message));
        } else {
            const newR = { name: name, isZone: false, pass: pass || null };
            myRooms.push(newR);
            saveRooms();
            enterRoom(newR);
        }
    }

    function renderRooms() {
        const list = document.getElementById('roomsList'); list.innerHTML = '';
        myRooms.forEach(r => {
            const icon = r.isZone ? 'üìç' : (r.pass ? 'üîí' : 'üåç');
            const btn = document.createElement('button');
            btn.className = 'sheet-btn';
            btn.innerHTML = `${icon} ${r.name}`;
            btn.onclick = () => tryJoinRoom(r);
            list.appendChild(btn);
        });
        openSheet('roomsSheet');
    }

    function tryJoinRoom(r) {
        // 1. ≈ûifr…ô yoxlanƒ±≈üƒ±
        if(r.pass) {
            const inputPass = prompt("Bu otaq ≈üifr…ôlidir. ≈ûifr…ôni daxil edin:");
            if(inputPass !== r.pass) return alert("S…ôhv ≈üifr…ô!");
        }

        // 2. M…ôkan yoxlanƒ±≈üƒ±
        if(r.isZone) {
            alert("M…ôkanƒ±nƒ±z yoxlanƒ±lƒ±r...");
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = getDist(pos.coords.latitude, pos.coords.longitude, r.lat, r.lng);
                // Radius 0.2 km (200 metr) edildi ki, giri≈ü daha rahat olsun
                if(dist > 0.2) return alert("T…ô…ôss√ºf, bu otaƒüa girm…ôk √º√ß√ºn m…ôkana √ßox uzaqsƒ±nƒ±z!");
                enterRoom(r);
            }, () => alert("GPS-…ô icaz…ô verilm…ôdi. M…ôkan otaƒüƒ±na giril…ô bilm…ôz."));
        } else {
            enterRoom(r);
        }
    }

    function enterRoom(r) {
        currentRoomName = r.name;
        document.getElementById('roomTitle').innerText = r.name;
        closeSheets(); 
        loadMsgs();
    }

    // --- K√ñM∆èK√áƒ∞ ---
    function getDist(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function saveRooms() { localStorage.setItem('x_rooms', JSON.stringify(myRooms)); }
    function openSheet(id) { document.getElementById(id).classList.add('active'); }
    function closeSheets() { document.querySelectorAll('.sheet-overlay').forEach(s => s.classList.remove('active')); }
    function logout() { localStorage.clear(); location.reload(); }

    init();
</script>
</body>
</html>
 
