<script>
    // --- ≈û∆èKƒ∞L SIXMA (RESIZER) FUNKSƒ∞YASI ---
    // Bu funksiya ≈ü…ôkill…ôri ki√ßildir ki, "Aƒü ekran" v…ô "Kod yƒ±ƒüƒ±nƒ±" problemi olmasƒ±n
    function compressImage(file, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = event => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800; // ≈û…ôkli maksimum bu √∂l√ß√ºy…ô g…ôtiririk
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_WIDTH) {
                        width *= MAX_WIDTH / height;
                        height = MAX_WIDTH;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL('image/jpeg', 0.7)); // 70% keyfiyy…ôtl…ô sƒ±xƒ±r
            };
        };
    }

    // --- ARXA FON D∆èYƒ∞≈ûM∆è FUNKSƒ∞YASI (YENƒ∞L∆èNDƒ∞) ---
    function changeBg(input) {
        if (!input.files[0]) return;
        compressImage(input.files[0], (compressedBase64) => {
            document.body.style.backgroundImage = `url(${compressedBase64})`;
            document.body.style.backgroundSize = "cover";
            document.body.style.backgroundPosition = "center";
            document.body.style.backgroundAttachment = "fixed";
            localStorage.setItem('x_bg', compressedBase64);
        });
    }

    // --- ≈û∆èKƒ∞L MESAJI G√ñND∆èRM∆è (YENƒ∞L∆èNDƒ∞) ---
    function sImg(input) {
        if (!input.files[0]) return;
        compressImage(input.files[0], async (compressedBase64) => {
            await sb.from('messages').insert([{ 
                content: 'IMG:' + compressedBase64, 
                nickname: user.n, 
                group_id: currentRoom 
            }]);
        });
    }

    // --- RENDER FUNKSƒ∞YASI (DAHA D∆èQƒ∞Q YOXlama) ---
    function render(m) {
        if(document.getElementById('m-'+m.id)) return;
        const isMe = m.nickname === user.n;
        const div = document.createElement('div');
        div.id = 'm-'+m.id;
        div.className = `msg ${isMe ? 'my' : ''}`;
        
        let c = m.content;
        let finalContent = "";

        if(c.startsWith('IMG:')) {
            finalContent = `<img src="${c.replace('IMG:','')}" class="msg-img" style="max-width:250px; border-radius:15px; border: 2px solid var(--accent);">`;
        } else if(c.startsWith('VOICE:')) {
            finalContent = `<div class="bub" onclick="new Audio('${c.replace('VOICE:','')}').play()" style="cursor:pointer">üîä S…ôsli Mesaj (Dinl…ô)</div>`;
        } else {
            finalContent = `<div class="bub">${c}</div>`;
        }

        div.innerHTML = `
            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${m.nickname}" style="width:30px; border-radius:50%; background:#1e293b;">
            ${finalContent}
        `;
        document.getElementById('chat').appendChild(div);
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }
</script>

<style>
    /* Arxa fonun tam oturmasƒ± √º√ß√ºn CSS */
    body {
        background-color: #050810;
        background-size: cover !important;
        background-position: center !important;
        background-attachment: fixed !important;
        background-repeat: no-repeat !important;
    }
    .msg-img {
        transition: transform 0.3s;
        cursor: pointer;
    }
    .msg-img:active {
        transform: scale(1.5); /* ≈û…ôkl…ô basanda b√∂y√ºd√ºr */
        z-index: 1000;
        position: relative;
    }
</style>
 
