<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>X-Chat V6 SOCIAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0b0d10; --panel: #16191f; --blue: #3b82f6; --me: #2b5278; --other: #1c2128; --text: #ffffff; }
        .theme-blue { --bg: #0a192f; --panel: #112240; --me: #233554; --blue: #64ffda; }
        .theme-purple { --bg: #1a1025; --panel: #2d1b3d; --me: #4b2d61; --blue: #bd93f9; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; transition: 0.3s; }

        #loginPage { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .card { background: var(--panel); width: 100%; max-width: 400px; padding: 30px; border-radius: 28px; text-align: center; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .ava-box { width: 80px; height: 80px; border-radius: 50%; background: #000; margin: 0 auto 15px; border: 2px dashed var(--blue); display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; position: relative; }
        .ava-box img { width: 100%; height: 100%; object-fit: cover; }
        input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 14px; border-radius: 12px; margin-bottom: 15px; outline: none; font-size: 15px; }
        input:focus { border-color: var(--blue); }
        .main-btn { width: 100%; background: var(--blue); color: #fff; border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 15px; }

        #mainApp { display: none; height: 100%; flex-direction: column; }
        header { background: var(--panel); padding: max(10px, env(safe-area-inset-top)) 15px 10px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 10; }
        
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 20px 20px; }
        .msg-box { max-width: 82%; padding: 10px 14px; border-radius: 18px; position: relative; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; background: var(--other); border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }

        .footer { background: var(--panel); padding: 10px 10px calc(env(safe-area-inset-bottom) + 10px); display: flex; align-items: center; gap: 8px; }
        .inp-wrap { flex: 1; background: #000; border-radius: 24px; padding: 0 15px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        #mInp { border: none; background: transparent; color: #fff; padding: 12px 0; flex: 1; outline: none; }
        .btn { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; font-size: 18px; cursor: pointer; }

        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: none; align-items: flex-end; backdrop-filter: blur(2px); opacity: 0; transition: 0.3s; }
        .sheet-overlay.active { display: flex; opacity: 1; }
        .sheet { width: 100%; background: var(--panel); border-radius: 24px 24px 0 0; padding: 20px; transform: translateY(100%); transition: 0.3s; padding-bottom: max(20px, env(safe-area-inset-bottom)); max-height: 80vh; overflow-y: auto;}
        .sheet-overlay.active .sheet { transform: translateY(0); }
        .sheet-btn { width: 100%; padding: 16px; background: rgba(255,255,255,0.05); border: none; color: #fff; border-radius: 14px; margin-bottom: 8px; text-align: left; font-size: 15px; font-weight: 500; }

        /* Dostlar Paneli √ú√ß√ºn X√ºsusi Dizayn */
        .friend-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 12px; margin-bottom: 8px; }
        .req-dot { width: 10px; height: 10px; background: #ef4444; border-radius: 50%; position: absolute; top: -2px; right: -2px; display: none; }
        .action-btn { padding: 8px 15px; border-radius: 8px; border: none; color: white; cursor: pointer; font-size: 12px; font-weight: bold; }
        
        img.msg-img { max-width: 100%; border-radius: 12px; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="card">
            <h2 style="margin-bottom: 20px; color: var(--blue);">X-Chat V6</h2>
            <div class="ava-box" onclick="document.getElementById('avaFile').click()">
                <img id="avaPrev" style="display:none">
                <span id="avaPlus" style="font-size:24px">üì∏</span>
            </div>
            <input type="file" id="avaFile" hidden accept="image/*" onchange="uploadAva()">
            <input type="text" id="nickInp" placeholder="Adƒ±nƒ±z (Nik)">
            <button class="main-btn" onclick="handleLogin()">Sistem…ô Daxil Ol</button>
        </div>
    </div>

    <div id="mainApp">
        <header>
            <div style="display:flex; align-items:center; gap:10px; cursor:pointer" onclick="openSheet('settingsSheet')">
                <img id="myAva" style="width:40px; height:40px; border-radius:50%; border:2px solid var(--blue); object-fit:cover">
                <div>
                    <b id="roomTitle" style="font-size:16px">General</b>
                </div>
            </div>
            <div style="display:flex; gap:15px; font-size:22px; position: relative;">
                <span onclick="openFriends()" style="position:relative">üë•<div id="reqDot" class="req-dot"></div></span>
                <span onclick="openSheet('themeSheet')">üé®</span>
            </div>
        </header>

        <div id="chat"></div>

        <div class="footer">
            <span onclick="openSheet('attachSheet')" style="font-size:26px; padding:0 8px; color:var(--blue)">+</span>
            <div class="inp-wrap">
                <input type="text" id="mInp" placeholder="Mesaj yaz..." onkeypress="if(event.key==='Enter') sendMsg()">
            </div>
            <button class="btn" style="background:var(--blue); color:#fff" onclick="sendMsg()">‚û§</button>
        </div>
    </div>

    <div id="dmSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <div style="text-align:center; margin-bottom:15px">
            <img id="dmAva" src="" style="width:70px; height:70px; border-radius:50%; margin-bottom:10px; border:2px solid var(--blue)">
            <h3 id="dmTargetName" style="margin:0; color:var(--blue)"></h3>
        </div>
        <button id="dmBtn" class="sheet-btn" style="background:var(--blue); text-align:center">üí¨ DM Yaz</button>
        <button id="addFriendBtn" class="sheet-btn" style="background:rgba(16, 185, 129, 0.2); color:#10b981; text-align:center; border: 1px solid rgba(16, 185, 129, 0.4)">ü§ù Dostluq G√∂nd…ôr</button>
    </div></div>

    <div id="friendsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px">
            <h2>üë• Sosial Panel</h2>
            <span onclick="closeSheets()" style="font-size:28px; opacity:0.5">√ó</span>
        </div>
        
        <h4 style="color:var(--blue); margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px">üîî Dostluq ƒ∞st…ôkl…ôri</h4>
        <div id="requestsList" style="margin-bottom:20px; font-size:13px; color:#aaa">ƒ∞st…ôk yoxdur.</div>

        <h4 style="color:var(--blue); margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px">ü§ù M…ônim Dostlarƒ±m</h4>
        <div id="friendsListContainer" style="font-size:13px; color:#aaa">H…ôl…ô dostun yoxdur.</div>
    </div></div>

    <div id="settingsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="goGlobal()">üåê Qlobal √áat</button>
        <button class="sheet-btn" style="color:#ef4444" onclick="logout()">üõë √áƒ±xƒ±≈ü Et</button>
    </div></div>
    
    <div id="themeSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="setTheme('')">üåë Qaranlƒ±q</button>
        <button class="sheet-btn" onclick="setTheme('theme-blue')">üåä Okean</button>
    </div></div>

    <div id="attachSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="document.getElementById('fInp').click()">üñº ≈û…ôkil G√∂nd…ôr</button>
    </div></div>
    <input type="file" id="fInp" hidden accept="image/*" onchange="uploadFile()">

<script>
    // SUPABASE
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user'));
    let myFriends = JSON.parse(localStorage.getItem('x_friends')) || []; 
    let room = 'General';
    let uploadedAvaUrl = "";
    let pendingRequests = [];

    // BA≈ûLANƒûIC
    function checkLogin() {
        if(user) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            document.getElementById('myAva').src = user.ava;
            document.body.className = localStorage.getItem('theme') || '';
            
            loadMsgs();
            fetchFriendRequests(); // Gir…ôn kimi ist…ôkl…ôri yoxla
            
            // Realtime: H…ôm normal mesajlarƒ±, h…ôm d…ô s…ôn…ô g…ôl…ôn dostluq ist…ôkl…ôrini dinl…ôyirik
            sb.channel('updates').on('postgres_changes', {event:'INSERT', schema:'public', table:'messages'}, payload => {
                const m = payload.new;
                if(m.group_id === room) loadMsgs(); // ∆èg…ôr otaqdasansa mesajƒ± yenil…ô
                if(m.group_id === 'REQ_' + user.nick) handleSystemMsg(m); // ∆èg…ôr s…ôn…ô sistem/dostluq mesajƒ± g…ôlibs…ô
            }).subscribe();
        }
    }

    async function uploadAva() {
        const file = document.getElementById('avaFile').files[0]; if(!file) return;
        const { data } = await sb.storage.from('audio_messages').upload(`ava_${Date.now()}.png`, file);
        uploadedAvaUrl = `${SB_URL}/storage/v1/object/public/audio_messages/${data.path}`;
        document.getElementById('avaPrev').src = uploadedAvaUrl;
        document.getElementById('avaPrev').style.display = 'block';
        document.getElementById('avaPlus').style.display = 'none';
    }

    function handleLogin() {
        const nick = document.getElementById('nickInp').value.trim();
        if(!nick) return alert('Ad vacibdir!');
        user = { nick, ava: uploadedAvaUrl || `https://ui-avatars.com/api/?name=${nick}&background=random` };
        localStorage.setItem('x_user', JSON.stringify(user));
        location.reload();
    }

    // --- DOSTLUQ Sƒ∞STEMƒ∞ M∆èNTƒ∞Qƒ∞ ---

    // 1. Profil…ô basanda a√ßƒ±lan modal
    function openDM(targetNick, targetAva) {
        if(targetNick === user.nick) return;
        document.getElementById('dmTargetName').innerText = targetNick;
        document.getElementById('dmAva').src = targetAva;
        
        // ∆èg…ôr artƒ±q dostdursa, "Dostluq at" d√ºym…ôsini gizl…ôt
        const isFriend = myFriends.find(f => f.nick === targetNick);
        const addBtn = document.getElementById('addFriendBtn');
        
        if(isFriend) {
            addBtn.style.display = 'none';
        } else {
            addBtn.style.display = 'block';
            addBtn.onclick = () => sendFriendReq(targetNick, targetAva);
        }

        document.getElementById('dmBtn').onclick = () => {
            room = 'DM_' + [user.nick, targetNick].sort().join('_');
            document.getElementById('roomTitle').innerText = 'üë§ ' + targetNick;
            closeSheets(); loadMsgs();
        };
        openSheet('dmSheet');
    }

    // 2. Dostluq ƒ∞st…ôyi G√∂nd…ôrm…ôk
    async function sendFriendReq(targetNick, targetAva) {
        addBtn = document.getElementById('addFriendBtn');
        addBtn.innerText = "‚è≥ G√∂nd…ôrilir...";
        
        // M…ôlumatƒ± bazaya sistem mesajƒ± kimi yazƒ±rƒ±q (group_id = 'REQ_HedefAd')
        const payload = { type: 'friend_request', from: user.nick, ava: user.ava };
        await sb.from('messages').insert([{ nickname: user.nick, group_id: 'REQ_' + targetNick, content: JSON.stringify(payload) }]);
        
        addBtn.innerText = "‚úÖ G√∂nd…ôrildi!";
        addBtn.style.background = "transparent";
        setTimeout(closeSheets, 1000);
    }

    // 3. G…ôl…ôn Sistem Mesajlarƒ±nƒ± (ƒ∞st…ôkl…ôri) Oxumaq
    function handleSystemMsg(m) {
        try {
            let data = JSON.parse(m.content);
            if(data.type === 'friend_request') {
                document.getElementById('reqDot').style.display = 'block'; // Qƒ±rmƒ±zƒ± n√∂qt…ôni yandƒ±r
                fetchFriendRequests(); // Siyahƒ±nƒ± yenil…ô
            }
            if(data.type === 'req_accepted') {
                // Qar≈üƒ± t…ôr…ôf q…ôbul edibs…ô, onu dostlarƒ±na …ôlav…ô et
                if(!myFriends.find(f => f.nick === data.from)) {
                    myFriends.push({ nick: data.from, ava: data.ava });
                    localStorage.setItem('x_friends', JSON.stringify(myFriends));
                    alert(`üéâ ${data.from} dostluq ist…ôyini q…ôbul etdi!`);
                }
                // H…ômin t…ôsdiq mesajƒ±nƒ± bazadan sil ki, t…ôkrar g…ôlm…ôsin
                sb.from('messages').delete().eq('id', m.id).then();
            }
        } catch(e) {}
    }

    // 4. B√ºt√ºn g√∂zl…ôy…ôn ist…ôkl…ôri bazadan √ß…ôkm…ôk
    async function fetchFriendRequests() {
        const { data } = await sb.from('messages').select('*').eq('group_id', 'REQ_' + user.nick);
        pendingRequests = data.filter(m => { try{ return JSON.parse(m.content).type === 'friend_request'; }catch{return false;} });
        
        if(pendingRequests.length > 0) document.getElementById('reqDot').style.display = 'block';
        else document.getElementById('reqDot').style.display = 'none';
        
        renderFriendsPanel();
    }

    // 5. Dostlar Panelini UI-da G√∂st…ôrm…ôk
    function openFriends() {
        renderFriendsPanel();
        openSheet('friendsSheet');
    }

    function renderFriendsPanel() {
        // ƒ∞st…ôkl…ôr siyahƒ±sƒ±
        const reqDiv = document.getElementById('requestsList');
        if(pendingRequests.length === 0) {
            reqDiv.innerHTML = "Yeni ist…ôk yoxdur.";
        } else {
            reqDiv.innerHTML = pendingRequests.map(m => {
                let d = JSON.parse(m.content);
                return `
                <div class="friend-item">
                    <div style="display:flex; align-items:center; gap:10px">
                        <img src="${d.ava}" style="width:35px; height:35px; border-radius:50%">
                        <b style="color:#fff">${d.from}</b>
                    </div>
                    <div>
                        <button class="action-btn" style="background:#10b981; margin-right:5px" onclick="acceptReq('${m.id}', '${d.from}', '${d.ava}')">Q…ôbul et</button>
                        <button class="action-btn" style="background:#ef4444" onclick="rejectReq('${m.id}')">Sil</button>
                    </div>
                </div>`;
            }).join('');
        }

        // Dostlarƒ±m siyahƒ±sƒ±
        const frDiv = document.getElementById('friendsListContainer');
        if(myFriends.length === 0) {
            frDiv.innerHTML = "H…ôl…ô dostun yoxdur. √áatda kims…ô tap!";
        } else {
            frDiv.innerHTML = myFriends.map(f => `
                <div class="friend-item" onclick="openDM('${f.nick}', '${f.ava}')" style="cursor:pointer">
                    <div style="display:flex; align-items:center; gap:10px">
                        <img src="${f.ava}" style="width:35px; height:35px; border-radius:50%">
                        <b style="color:#fff">${f.nick}</b>
                    </div>
                    <span style="color:var(--blue)">üí¨ Yaz</span>
                </div>
            `).join('');
        }
    }

    // 6. ƒ∞st…ôyi Q…ôbul Etm…ôk
    async function acceptReq(msgId, senderNick, senderAva) {
        // 1. √ñz siyahƒ±ma …ôlav…ô edir…ôm
        myFriends.push({ nick: senderNick, ava: senderAva });
        localStorage.setItem('x_friends', JSON.stringify(myFriends));
        
        // 2. ƒ∞st…ôk mesajƒ±nƒ± bazadan silir…ôm
        await sb.from('messages').delete().eq('id', msgId);
        
        // 3. Qar≈üƒ± t…ôr…ôf…ô "Q…ôbul etdim" mesajƒ± g√∂nd…ôrir…ôm ki, o da m…ôni …ôlav…ô etsin
        const payload = { type: 'req_accepted', from: user.nick, ava: user.ava };
        await sb.from('messages').insert([{ nickname: user.nick, group_id: 'REQ_' + senderNick, content: JSON.stringify(payload) }]);
        
        fetchFriendRequests(); // Ekranƒ± yenil…ô
    }

    // 7. ƒ∞st…ôyi R…ôdd Etm…ôk
    async function rejectReq(msgId) {
        await sb.from('messages').delete().eq('id', msgId);
        fetchFriendRequests();
    }

    // --- NORMAL √áAT FUNKSƒ∞YALARI ---
    async function loadMsgs() {
        const { data } = await sb.from('messages').select('*').eq('group_id', room).order('created_at',{ascending:true});
        const c = document.getElementById('chat'); c.innerHTML = '';
        data.forEach(m => {
            const isMe = m.nickname === user.nick;
            let body = '', j = {};
            try { j = JSON.parse(m.content); } catch { j = {text: m.content}; }
            
            if(j.type==='image') body = `<img src="${j.url}" class="msg-img">`;
            else body = j.text || '';

            const div = document.createElement('div');
            div.className = `msg-box ${isMe ? 'me' : 'other'}`;
            div.innerHTML = `
                ${!isMe ? `<div onclick="openDM('${m.nickname}', '${j.userAva || ''}')" style="color:var(--blue); font-size:12px; margin-bottom:4px; cursor:pointer; font-weight:bold">üë§ ${m.nickname}</div>` : ''}
                ${body}
                <div style="font-size:10px; opacity:0.5; text-align:right; margin-top:5px">${new Date(m.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
            `;
            c.appendChild(div);
        });
        c.scrollTop = c.scrollHeight;
    }

    async function sendMsg() {
        const i = document.getElementById('mInp'); const val = i.value.trim(); if(!val) return;
        i.value = '';
        await sb.from('messages').insert([{ nickname:user.nick, group_id:room, content: JSON.stringify({text:val, type:'text', userAva: user.ava}) }]);
    }

    async function uploadFile() {
        const f = document.getElementById('fInp').files[0]; if(!f) return;
        closeSheets();
        const { data } = await sb.storage.from('audio_messages').upload(`img_${Date.now()}_${f.name}`, f);
        const url = `${SB_URL}/storage/v1/object/public/audio_messages/${data.path}`;
        await sb.from('messages').insert([{ nickname:user.nick, group_id:room, content: JSON.stringify({url, type:'image', userAva: user.ava}) }]);
    }

    function openSheet(id) { document.getElementById(id).classList.add('active'); }
    function closeSheets() { document.querySelectorAll('.sheet-overlay').forEach(s => s.classList.remove('active')); }
    function goGlobal() { room = 'General'; document.getElementById('roomTitle').innerText = 'General'; closeSheets(); loadMsgs(); }
    function setTheme(t) { document.body.className = t; localStorage.setItem('theme', t); closeSheets(); }
    function logout() { localStorage.clear(); location.reload(); }

    checkLogin();
</script>
</body>
</html>
