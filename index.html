<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X-Chat Elite</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --accent: #00d2ff; --bg: #0b141a; --my-msg: #005c4b; --other-msg: #202c33; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        
        .header { padding: 10px 15px; background: #202c33; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #333; }
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        /* Mesaj Stili */
        .msg-row { display: flex; flex-direction: column; max-width: 80%; margin-bottom: 5px; }
        .msg-row.my { align-self: flex-end; align-items: flex-end; }
        .bubble { padding: 10px 14px; border-radius: 15px; background: var(--other-msg); position: relative; transition: transform 0.1s; -webkit-tap-highlight-color: transparent; }
        .my .bubble { background: var(--my-msg); }
        .bubble:active { transform: scale(0.96); opacity: 0.8; }
        
        .react-badge { font-size: 13px; background: rgba(0,0,0,0.4); padding: 2px 6px; border-radius: 10px; margin-top: 5px; display: inline-block; }
        .react-badge:empty { display: none; }

        /* Kontext Menyu (Sil/React) */
        #context-menu { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .menu-card { background: #2a3942; width: 250px; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .menu-btn { width: 100%; padding: 15px; border: none; background: transparent; color: #fff; font-size: 16px; text-align: left; cursor: pointer; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 10px; }
        .menu-btn:hover { background: rgba(255,255,255,0.05); }

        /* Input */
        .input-bar { padding: 10px; background: #202c33; display: flex; gap: 10px; align-items: center; }
        input#msgInp { flex: 1; padding: 12px; border-radius: 25px; border: none; background: #2a3942; color: #fff; outline: none; }
        
        #login { position: fixed; inset: 0; background: var(--bg); z-index: 20000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="login">
    <div style="background:#1c272d; padding:30px; border-radius:20px; text-align:center;">
        <h2 style="color:var(--accent)">X-Chat</h2>
        <input type="text" id="nick" placeholder="Adƒ±nƒ±z..." style="width:100%; padding:10px; border-radius:8px; border:none; background:#2a3942; color:#fff;"><br><br>
        <button onclick="login()" style="width:100%; padding:10px; border-radius:8px; border:none; background:var(--accent); font-weight:bold;">BA≈ûLA</button>
    </div>
</div>

<div class="header">
    <b>General Room</b>
    <img id="myAva" src="" style="width:35px; height:35px; border-radius:50%; border:2px solid var(--accent)">
</div>

<div id="chat"></div>

<div id="context-menu" onclick="closeMenu()">
    <div class="menu-card" onclick="event.stopPropagation()">
        <div style="padding: 10px; font-size: 12px; color: #8896a0; text-align: center;">Mesaj ∆èm…ôliyyatlarƒ±</div>
        <button class="menu-btn" onclick="triggerReact()">üòÄ Reaksiya Bildir</button>
        <button class="menu-btn" id="delBtn" style="color: #ff4d4d; border: none;" onclick="triggerDelete()">üóëÔ∏è Mesajƒ± Sil</button>
    </div>
</div>

<div class="input-bar">
    <input type="text" id="msgInp" placeholder="Mesaj..." onkeypress="if(event.key=='Enter') send()">
    <button onclick="send()" style="background:none; border:none; font-size:24px;">üöÄ</button>
</div>

<script>
    const URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(URL, KEY);

    let user = JSON.parse(localStorage.getItem('chat_elite_user'));
    let selectedMsgId = null;
    let pressTimer;

    if(user) { document.getElementById('login').style.display='none'; init(); }

    function login() {
        let n = document.getElementById('nick').value.trim();
        if(!n) return;
        user = { n, a: `https://ui-avatars.com/api/?name=${n}&background=random` };
        localStorage.setItem('chat_elite_user', JSON.stringify(user));
        location.reload();
    }

    function init() {
        document.getElementById('myAva').src = user.a;
        load();
        sb.channel('main').on('postgres_changes', {event:'*', schema:'public', table:'messages'}, (p) => {
            if(p.eventType === 'INSERT') render(p.new);
            if(p.eventType === 'DELETE') document.getElementById('msg-'+p.old.id)?.remove();
            if(p.eventType === 'UPDATE') {
                const b = document.querySelector(`#msg-${p.new.id} .react-badge`);
                if(b) b.innerText = (typeof p.new.reactions === 'string' && !p.new.reactions.includes('[object')) ? p.new.reactions : "";
            }
        }).subscribe();
    }

    async function load() {
        const {data} = await sb.from('messages').select('*').order('created_at');
        if(data) data.forEach(render);
    }

    function render(m) {
        if(document.getElementById('msg-'+m.id)) return;
        const isMy = m.nickname === user.n;
        const d = document.createElement('div');
        d.id = 'msg-'+m.id; d.className = `msg-row ${isMy?'my':''}`;
        
        let r = (typeof m.reactions === 'string' && !m.reactions.includes('[object')) ? m.reactions : "";

        d.innerHTML = `
            <span style="font-size:10px; opacity:0.6; margin-bottom:2px;">${m.nickname}</span>
            <div class="bubble" 
                 onmousedown="startPress(${m.id}, ${isMy})" 
                 ontouchstart="startPress(${m.id}, ${isMy})"
                 onmouseup="endPress()" 
                 ontouchend="endPress()">
                <div>${m.content}</div>
                <div class="react-badge">${r}</div>
                <div style="font-size:9px; text-align:right; opacity:0.5; margin-top:4px;">
                    ${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                </div>
            </div>
        `;
        document.getElementById('chat').appendChild(d);
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    // Long Press M…ôntiqi
    function startPress(id, isMy) {
        selectedMsgId = id;
        document.getElementById('delBtn').style.display = isMy ? 'flex' : 'none';
        pressTimer = setTimeout(() => {
            document.getElementById('context-menu').style.display = 'flex';
            if (window.navigator.vibrate) window.navigator.vibrate(50); // Titr…ô≈üim
        }, 500);
    }

    function endPress() { clearTimeout(pressTimer); }
    function closeMenu() { document.getElementById('context-menu').style.display = 'none'; }

    async function triggerDelete() {
        if(!confirm("Bu mesajƒ± silm…ôk ist…ôyirsiz?")) return;
        const id = selectedMsgId;
        document.getElementById('msg-'+id)?.remove();
        closeMenu();
        await sb.from('messages').delete().eq('id', id);
    }

    async function triggerReact() {
        const e = prompt("Emoji?");
        if(!e) return;
        const id = selectedMsgId;
        closeMenu();
        
        const badge = document.querySelector(`#msg-${id} .react-badge`);
        if(badge) badge.innerText += e;

        const {data} = await sb.from('messages').select('reactions').eq('id', id).single();
        let cur = (data && typeof data.reactions === 'string' && !data.reactions.includes('[object')) ? data.reactions : "";
        await sb.from('messages').update({reactions: cur + e}).eq('id', id);
    }

    async function send() {
        const i = document.getElementById('msgInp');
        if(!i.value.trim()) return;
        const v = i.value; i.value = "";
        await sb.from('messages').insert([{content: v, nickname: user.n, group_id: 'General', sender_avatar: user.a, reactions: ""}]);
    }
</script>
</body>
</html>
 
