<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>X-Chat SuperApp</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://meet.jit.si/external_api.js'></script>
    <style>
        :root { 
            --bg: #0f1115; --panel: #181a20; --blue: #3b82f6; 
            --me-bg: #2b5278; --other-bg: #222831; --text: #ffffff; 
            --border: rgba(255,255,255,0.08); 
        }
        /* MÃ¶vzular */
        .theme-blue { --bg: #0a192f; --panel: #112240; --me-bg: #233554; --blue: #64ffda; }
        .theme-purple { --bg: #1a1025; --panel: #2d1b3d; --me-bg: #4b2d61; --blue: #bd93f9; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, system-ui, sans-serif; }
        html, body { margin: 0; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; transition: 0.3s; }

        header { background: var(--panel); padding: max(10px, env(safe-area-inset-top)) 15px 10px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); z-index: 100; }
        #searchBar { display: none; flex: 1; margin: 0 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: #fff; border-radius: 10px; padding: 5px 10px; outline: none; }

        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg-wrap { display: flex; flex-direction: column; max-width: 80%; position: relative; animation: pop 0.2s ease; }
        @keyframes pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .msg-wrap.me { align-self: flex-end; }
        .msg-wrap.other { align-self: flex-start; }
        .msg { padding: 10px 14px; border-radius: 18px; font-size: 15px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .me .msg { background: var(--me-bg); border-bottom-right-radius: 4px; }
        .other .msg { background: var(--other-bg); border-bottom-left-radius: 4px; }
        .edited-tag { font-size: 9px; opacity: 0.5; margin-left: 5px; }

        .input-area { background: var(--panel); padding: 10px; display: flex; align-items: center; gap: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); border-top: 1px solid var(--border); }
        .text-wrap { flex: 1; background: rgba(0,0,0,0.2); border-radius: 20px; padding: 5px 15px; border: 1px solid var(--border); }
        input#mInp { width: 100%; background: transparent; border: none; color: #fff; padding: 8px 0; outline: none; font-size: 16px; }

        /* Bottom Sheet */
        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: flex-end; }
        .sheet { width: 100%; background: var(--panel); border-radius: 20px 20px 0 0; padding: 20px; transform: translateY(100%); transition: 0.3s; }
        .sheet-overlay.active { display: flex; }
        .sheet-overlay.active .sheet { transform: translateY(0); }
        .sheet-btn { width: 100%; padding: 15px; background: rgba(255,255,255,0.05); border: none; color: #fff; border-radius: 12px; margin-bottom: 10px; font-size: 16px; text-align: left; }

        .chat-img { width: 100%; border-radius: 10px; margin-top: 5px; }
        .file-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; display: flex; align-items: center; gap: 10px; font-size: 13px; text-decoration: none; color: #3b82f6; }
    </style>
</head>
<body class="">

    <header>
        <div style="display:flex; align-items:center; gap:10px" onclick="openSheet('menuSheet')">
            <img id="myAva" style="width:38px; height:38px; border-radius:50%; object-fit:cover">
            <b id="roomTitle">General</b>
        </div>
        <input type="text" id="searchBar" placeholder="Mesaj axtar..." oninput="filterMsgs()">
        <div style="display:flex; gap:15px; font-size:20px">
            <span onclick="toggleSearch()">ğŸ”</span>
            <span onclick="startCall()">ğŸ“</span>
        </div>
    </header>

    <div id="chat"></div>

    <div class="input-area">
        <span onclick="openSheet('attachSheet')" style="font-size:24px">ğŸ“</span>
        <div class="text-wrap">
            <input type="text" id="mInp" placeholder="Mesaj...">
        </div>
        <button id="sendBtn" onclick="sendText()" style="background:var(--blue); border:none; width:40px; height:40px; border-radius:50%; color:#000; font-weight:bold">â–²</button>
    </div>

    <div id="menuSheet" class="sheet-overlay" onclick="closeSheets()">
        <div class="sheet" onclick="event.stopPropagation()">
            <button class="sheet-btn" onclick="setTheme('')">ğŸŒ‘ Qara MÃ¶vzu</button>
            <button class="sheet-btn" onclick="setTheme('theme-blue')">ğŸŒŠ Okean Mavisi</button>
            <button class="sheet-btn" onclick="setTheme('theme-purple')">ğŸ”® BÉ™nÃ¶vÅŸÉ™yi GecÉ™</button>
            <button class="sheet-btn" onclick="changeRoom()">ğŸ”’ OtaÄŸÄ± DÉ™yiÅŸ</button>
            <button class="sheet-btn danger" onclick="logout()" style="color:#ff4d4d">ğŸ›‘ Ã‡Ä±xÄ±ÅŸ</button>
        </div>
    </div>

    <div id="attachSheet" class="sheet-overlay" onclick="closeSheets()">
        <div class="sheet" onclick="event.stopPropagation()">
            <button class="sheet-btn" onclick="document.getElementById('fInp').click()">ğŸ–¼ ÅÉ™kil GÃ¶ndÉ™r</button>
            <button class="sheet-btn" onclick="document.getElementById('fileInp').click()">ğŸ“‚ Fayl GÃ¶ndÉ™r (PDF, Doc)</button>
            <button class="sheet-btn" onclick="sendLocation()">ğŸ“ MÉ™kanÄ±mÄ± PaylaÅŸ</button>
        </div>
    </div>

    <div id="msgSheet" class="sheet-overlay" onclick="closeSheets()">
        <div class="sheet" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content:space-between; font-size:25px; margin-bottom:20px">
                <span onclick="addReact('â¤ï¸')">â¤ï¸</span><span onclick="addReact('ğŸ˜‚')">ğŸ˜‚</span><span onclick="addReact('ğŸ‘')">ğŸ‘</span><span onclick="addReact('ğŸ”¥')">ğŸ”¥</span>
            </div>
            <button id="editBtn" class="sheet-btn" onclick="editMsg()">âœï¸ RedaktÉ™ Et</button>
            <button class="sheet-btn" style="color:#ff4d4d" onclick="deleteMsg()">ğŸ—‘ Sil</button>
        </div>
    </div>

    <input type="file" id="fInp" hidden accept="image/*" onchange="upload('image')">
    <input type="file" id="fileInp" hidden onchange="upload('file')">

<script>
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user')) || { nick: 'Qonaq' + Math.floor(Math.random()*100), ava: 'https://ui-avatars.com/api/?name=User' };
    let room = 'General', selectedId, isEditing = false, holdTimer;
    const sendSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');

    function start() {
        document.getElementById('myAva').src = user.ava;
        loadMsgs();
        sb.channel('any').on('postgres_changes',{event:'*',schema:'public',table:'messages'},(payload)=>{
            if(payload.eventType === 'INSERT' && payload.new.nickname !== user.nick) sendSound.play();
            loadMsgs();
        }).subscribe();
    }

    async function loadMsgs() {
        const { data } = await sb.from('messages').select('*').eq('group_id', room).order('created_at',{ascending:true});
        const c = document.getElementById('chat'); c.innerHTML = '';
        data.forEach(m => {
            let body = '', reactions = [];
            try { 
                const j = JSON.parse(m.content); 
                reactions = j.reactions || [];
                if(j.type==='image') body = `<img src="${j.url}" class="chat-img">`;
                else if(j.type==='file') body = `<a href="${j.url}" class="file-box" target="_blank">ğŸ“„ ${j.name}</a>`;
                else if(j.type==='loc') body = `<a href="${j.url}" class="file-box" target="_blank">ğŸ“ MÉ™kanÄ±m (XÉ™ritÉ™dÉ™ gÃ¶r)</a>`;
                else body = j.text;
            } catch(e){ body = m.content; }

            const wrap = document.createElement('div');
            wrap.className = `msg-wrap ${m.nickname===user.nick?'me':'other'}`;
            wrap.innerHTML = `<div class="msg" ontouchstart="startHold('${m.id}')" ontouchend="clearHold()" onmousedown="startHold('${m.id}')" onmouseup="clearHold()">
                <div style="font-size:11px; color:var(--blue); font-weight:bold">${m.nickname}</div>
                ${body} ${m.updated_at !== m.created_at ? '<span class="edited-tag">(redaktÉ™ edildi)</span>' : ''}
                <div style="font-size:10px; opacity:0.5; text-align:right">${new Date(m.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                ${reactions.length ? `<div style="position:absolute; bottom:-10px; right:5px; background:#1e293b; border-radius:10px; padding:2px 5px; font-size:12px">${reactions.join('')}</div>` : ''}
            </div>`;
            c.appendChild(wrap);
        });
        c.scrollTop = c.scrollHeight;
    }

    async function sendText() {
        const i = document.getElementById('mInp'); if(!i.value) return;
        const val = i.value; i.value = '';
        if(isEditing) {
            const { data } = await sb.from('messages').select('content').eq('id', selectedId).single();
            let c = JSON.parse(data.content); c.text = val;
            await sb.from('messages').update({ content: JSON.stringify(c) }).eq('id', selectedId);
            isEditing = false;
        } else {
            await sb.from('messages').insert([{ nickname:user.nick, group_id:room, content: JSON.stringify({text:val, type:'text', reactions:[]}) }]);
            sendSound.play();
        }
    }

    async function upload(type) {
        closeSheets();
        const f = type==='image' ? document.getElementById('fInp').files[0] : document.getElementById('fileInp').files[0];
        const name = Date.now() + '_' + f.name;
        await sb.storage.from('audio_messages').upload(name, f);
        const url = `${SB_URL}/storage/v1/object/public/audio_messages/${name}`;
        await sb.from('messages').insert([{ nickname:user.nick, group_id:room, content: JSON.stringify({url, type, name:f.name}) }]);
    }

    function sendLocation() {
        navigator.geolocation.getCurrentPosition(async p => {
            const url = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
            await sb.from('messages').insert([{ nickname:user.nick, group_id:room, content: JSON.stringify({url, type:'loc'}) }]);
            closeSheets();
        });
    }

    // UI Tools
    function toggleSearch() { const s = document.getElementById('searchBar'); s.style.display = s.style.display==='none'?'block':'none'; if(s.style.display==='none') loadMsgs(); }
    function filterMsgs() { 
        const term = document.getElementById('searchBar').value.toLowerCase();
        document.querySelectorAll('.msg-wrap').forEach(m => {
            m.style.display = m.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
        });
    }
    function setTheme(t) { document.body.className = t; localStorage.setItem('theme', t); closeSheets(); }
    function startHold(id) { selectedId = id; holdTimer = setTimeout(() => openSheet('msgSheet'), 500); }
    function clearHold() { clearTimeout(holdTimer); }
    function openSheet(id) { document.getElementById(id).classList.add('active'); }
    function closeSheets() { document.querySelectorAll('.sheet-overlay').forEach(s => s.classList.remove('active')); }
    function editMsg() { isEditing = true; closeSheets(); document.getElementById('mInp').focus(); }
    async function deleteMsg() { if(confirm('Silinsin?')) await sb.from('messages').delete().eq('id', selectedId); closeSheets(); }
    async function addReact(e) {
        const { data } = await sb.from('messages').select('content').eq('id', selectedId).single();
        let c = JSON.parse(data.content); if(!c.reactions) c.reactions = []; c.reactions.push(e);
        await sb.from('messages').update({ content: JSON.stringify(c) }).eq('id', selectedId);
        closeSheets();
    }
    document.body.className = localStorage.getItem('theme') || '';
    start();
</script>
</body>
</html>
