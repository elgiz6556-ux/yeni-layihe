<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>X-Chat Mobile</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://meet.jit.si/external_api.js'></script>

    <style>
        /* --- MOBƒ∞L √ú√á√úN RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        :root {
            --bg: #0f172a;
            --header: #1e293b;
            --primary: #3b82f6;
            --msg-me: #2563eb;
            --msg-other: #334155;
            --text: #f8fafc;
            --subtext: #94a3b8;
            --input-bg: #1e293b;
            --border: rgba(255,255,255,0.1);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100dvh; /* Brauzer panell…ôri n…ôz…ôr…ô alƒ±nƒ±r */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Gƒ∞Rƒ∞≈û EKRANI (FULL SCREEN) --- */
        #auth-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }
        .logo-text { font-size: 32px; font-weight: 700; background: linear-gradient(to right, #60a5fa, #a78bfa); -webkit-background-clip: text; color: transparent; margin-bottom: 40px; }
        
        .mobile-inp {
            width: 100%; padding: 16px; margin: 8px 0; border-radius: 16px;
            background: var(--header); border: 1px solid var(--border);
            color: white; font-size: 16px;
        }
        .mobile-btn {
            width: 100%; padding: 18px; margin-top: 20px;
            background: var(--primary); border: none; border-radius: 16px;
            color: white; font-size: 18px; font-weight: 600; cursor: pointer;
        }

        /* --- APP HEADER (FIXED TOP) --- */
        .app-header {
            height: 60px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(12px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 50;
        }

        .header-profile { display: flex; align-items: center; gap: 12px; }
        .h-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .h-info h3 { margin: 0; font-size: 16px; font-weight: 600; }
        .h-info span { font-size: 12px; color: #10b981; }

        .header-icons { display: flex; gap: 16px; font-size: 20px; }

        /* --- CHAT AREA (SCROLLABLE) --- */
        #chat-container {
            flex: 1;
            overflow-y: scroll;
            padding: 16px 12px 20px 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            -webkit-overflow-scrolling: touch; /* ƒ∞OS √º√ß√ºn hamar s√ºr√º≈üd√ºrm…ô */
        }
        
        /* Scrollbar-ƒ± gizl…ôt */
        #chat-container::-webkit-scrollbar { display: none; }

        /* Mesaj Baloncuklarƒ± */
        .msg-wrapper { display: flex; flex-direction: column; max-width: 80%; position: relative; }
        .msg-wrapper.my { align-self: flex-end; align-items: flex-end; }
        
        .bubble {
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .msg-wrapper.my .bubble {
            background: var(--msg-me);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .msg-wrapper:not(.my) .bubble {
            background: var(--msg-other);
            color: var(--text);
            border-bottom-left-radius: 4px;
        }

        .sender-label { font-size: 11px; color: var(--subtext); margin-bottom: 4px; margin-left: 10px; }
        .time-label { font-size: 10px; opacity: 0.7; margin-top: 4px; text-align: right; display: block; }

        /* --- BOTTOM INPUT (FIXED) --- */
        .input-dock {
            background: var(--header);
            padding: 10px 12px;
            padding-bottom: max(10px, env(safe-area-inset-bottom)); /* iPhone alt x…ôtt √º√ß√ºn */
            display: flex; align-items: center; gap: 10px;
            border-top: 1px solid var(--border);
        }

        .dock-btn {
            width: 40px; height: 40px; border-radius: 50%;
            border: none; background: transparent; color: var(--subtext);
            font-size: 22px; display: flex; align-items: center; justify-content: center;
        }
        .dock-btn:active { background: rgba(255,255,255,0.1); color: var(--primary); }

        .text-field {
            flex: 1;
            background: rgba(0,0,0,0.2);
            border-radius: 24px;
            padding: 10px 16px;
            display: flex; align-items: center;
        }
        .text-field input {
            width: 100%; background: transparent; border: none;
            color: white; font-size: 16px; height: 24px;
            padding: 0; margin: 0;
        }

        .send-fab {
            width: 44px; height: 44px; border-radius: 50%;
            background: var(--primary); color: white; border: none;
            font-size: 20px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }

        /* --- SIDEBAR MENU (DRAWER) --- */
        .drawer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 200;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .drawer.open { opacity: 1; pointer-events: all; }
        
        .drawer-content {
            position: absolute; top: 0; left: 0; width: 80%; height: 100%;
            background: var(--bg); transform: translateX(-100%);
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 20px; box-shadow: 5px 0 25px rgba(0,0,0,0.5);
        }
        .drawer.open .drawer-content { transform: translateX(0); }

        .menu-item {
            padding: 16px; border-radius: 12px; margin-bottom: 8px;
            background: rgba(255,255,255,0.03); font-size: 16px;
            display: flex; align-items: center; gap: 10px;
        }
        .menu-item.danger { color: #ef4444; background: rgba(239, 68, 68, 0.1); }

        /* Multimedia Elements */
        .chat-img { width: 100%; border-radius: 12px; margin-top: 5px; }
        .mic-recording { color: #ef4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

        /* Z…ông Frame */
        #call-overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; }
        .end-call-btn {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; padding: 15px 40px; border-radius: 30px;
            font-weight: bold; border: none; box-shadow: 0 5px 15px rgba(239,68,68,0.5);
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="logo-text">X-CHAT APP</div>
        <input type="text" id="logNick" class="mobile-inp" placeholder="Adƒ±nƒ±z (M…ôs: Tural)">
        <input type="password" id="logPass" class="mobile-inp" placeholder="≈ûifr…ô">
        <button class="mobile-btn" onclick="login()">Gƒ∞Rƒ∞≈û ET</button>
    </div>

    <header class="app-header">
        <div class="header-profile" onclick="toggleDrawer()">
            <img id="navAvatar" class="h-avatar" src="">
            <div class="h-info">
                <h3 id="roomTitle">General</h3>
                <span>Onlayn</span>
            </div>
        </div>
        <div class="header-icons">
            <span onclick="startCall()">üìû</span>
        </div>
    </header>

    <div id="chat-container">
        </div>

    <div class="input-dock">
        <input type="file" id="fileInp" hidden accept="image/*" onchange="sendFile(this)">
        <button class="dock-btn" onclick="document.getElementById('fileInp').click()">üì∑</button>
        <button class="dock-btn" id="micBtn" onclick="toggleMic()">üéôÔ∏è</button>
        <div class="text-field">
            <input type="text" id="msgInp" placeholder="Mesaj yaz..." autocomplete="off">
        </div>
        <button class="send-fab" onclick="sendText()">‚û§</button>
    </div>

    <div class="drawer" id="mainDrawer" onclick="toggleDrawer()">
        <div class="drawer-content" onclick="event.stopPropagation()">
            <h2 style="margin-top:0">Menyu</h2>
            
            <div style="text-align:center; margin: 20px 0;">
                <img id="drawerAvatar" class="h-avatar" style="width:80px; height:80px;" src="">
                <button onclick="document.getElementById('avatarInp').click()" style="display:block; margin:10px auto; background:none; border:1px solid var(--border); color:var(--primary); padding:5px 10px; border-radius:8px;">Fotonu D…ôyi≈ü</button>
                <input type="file" id="avatarInp" hidden onchange="uploadAvatar(this)">
            </div>

            <div class="menu-item" onclick="changeRoom('General')">#Ô∏è‚É£ General</div>
            <div class="menu-item" onclick="createPrivateRoom()">üîí ≈û…ôxsi Otaq</div>
            <div class="menu-item" onclick="document.getElementById('bgInp').click()">üñº Arxa Fonu D…ôyi≈ü</div>
            <input type="file" id="bgInp" hidden onchange="changeBg(this)">
            
            <div style="flex:1"></div>
            <div class="menu-item danger" onclick="logout()">√áƒ±xƒ±≈ü</div>
        </div>
    </div>

    <div id="call-overlay">
        <div id="jitsi-frame" style="width:100%; height:100%;"></div>
        <button class="end-call-btn" onclick="endCall()">Bitir</button>
    </div>

<script>
    // SUPABASE CONFIG
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user'));
    let room = 'General';
    let mediaRec, chunks = [];

    // --- INIT ---
    if(user) initApp();
    
    // Klaviatura a√ßƒ±landa ekran s√ºr√º≈üm…ôsinin qar≈üƒ±sƒ±nƒ± almaq
    const viewport = document.querySelector('meta[name=viewport]');
    viewport.setAttribute('content', viewport.content + ', height=' + window.innerHeight);

    function login() {
        const nick = document.getElementById('logNick').value;
        if(!nick) return alert("Ad yazƒ±n");
        user = { nick, avatar: `https://ui-avatars.com/api/?name=${nick}&background=random` };
        localStorage.setItem('x_user', JSON.stringify(user));
        initApp();
    }

    function initApp() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('navAvatar').src = user.avatar;
        document.getElementById('drawerAvatar').src = user.avatar;
        
        const bg = localStorage.getItem('x_bg');
        if(bg) document.body.style.backgroundImage = `url(${bg})`;
        document.body.style.backgroundSize = "cover";

        loadMsgs();
        
        sb.channel('public:messages')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
              if(payload.new.group_id === room) renderMsg(payload.new);
          })
          .subscribe();
    }

    async function loadMsgs() {
        const cont = document.getElementById('chat-container');
        cont.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.5">Y√ºkl…ônir...</div>';
        const { data } = await sb.from('messages').select('*').eq('group_id', room).order('created_at', {ascending: true});
        cont.innerHTML = '';
        if(data) data.forEach(renderMsg);
    }

    function renderMsg(msg) {
        let content = msg.content;
        let type = 'text';
        let reaction = '';

        try {
            const json = JSON.parse(msg.content);
            if(json.text) { content = json.text; type = json.type; reaction = json.reaction; }
        } catch(e) {}

        const isMe = msg.nickname === user.nick;
        const div = document.createElement('div');
        div.className = `msg-wrapper ${isMe ? 'my' : ''}`;
        
        let inner = content;
        if(type === 'image') inner = `<img src="${content}" class="chat-img" onclick="window.open(this.src)">`;
        if(type === 'audio') inner = `<audio src="${content}" controls style="height:30px; width:200px;"></audio>`;

        div.innerHTML = `
            ${!isMe ? `<span class="sender-label">${msg.nickname}</span>` : ''}
            <div class="bubble" ondblclick="addReact('${msg.id}', '${msg.content}')" oncontextmenu="delMsg('${msg.id}','${msg.nickname}');return false;">
                ${inner}
                <span class="time-label">${new Date(msg.created_at).getHours()}:${String(new Date(msg.created_at).getMinutes()).padStart(2,'0')} ${reaction}</span>
            </div>
        `;
        
        const cont = document.getElementById('chat-container');
        cont.appendChild(div);
        cont.scrollTop = cont.scrollHeight;
    }

    // --- ACTIONS ---
    async function sendText() {
        const inp = document.getElementById('msgInp');
        if(!inp.value.trim()) return;
        const payload = JSON.stringify({ text: inp.value, type: 'text' });
        inp.value = '';
        await sb.from('messages').insert([{ nickname: user.nick, group_id: room, content: payload }]);
    }

    async function sendFile(el) {
        const file = el.files[0];
        if(!file) return;
        const name = `img_${Date.now()}.jpg`;
        const { data } = await sb.storage.from('audio_messages').upload(name, file);
        const url = `${SB_URL}/storage/v1/object/public/audio_messages/${name}`;
        const payload = JSON.stringify({ text: url, type: 'image' });
        await sb.from('messages').insert([{ nickname: user.nick, group_id: room, content: payload }]);
    }

    async function toggleMic() {
        const btn = document.getElementById('micBtn');
        if(!mediaRec || mediaRec.state === 'inactive') {
            const stream = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRec = new MediaRecorder(stream);
            chunks = [];
            mediaRec.ondataavailable = e => chunks.push(e.data);
            mediaRec.onstop = async () => {
                const blob = new Blob(chunks, {type:'audio/webm'});
                const name = `voice_${Date.now()}.webm`;
                await sb.storage.from('audio_messages').upload(name, blob);
                const url = `${SB_URL}/storage/v1/object/public/audio_messages/${name}`;
                const payload = JSON.stringify({ text: url, type: 'audio' });
                await sb.from('messages').insert([{ nickname: user.nick, group_id: room, content: payload }]);
                btn.classList.remove('mic-recording');
            };
            mediaRec.start();
            btn.classList.add('mic-recording');
        } else {
            mediaRec.stop();
        }
    }

    // --- UTILS ---
    function toggleDrawer() {
        document.getElementById('mainDrawer').classList.toggle('open');
    }

    function changeRoom(newRoom) {
        room = newRoom;
        document.getElementById('roomTitle').innerText = room;
        toggleDrawer();
        loadMsgs();
    }

    function createPrivateRoom() {
        const r = prompt("Otaq adƒ±:");
        if(r) changeRoom(r);
    }

    async function uploadAvatar(el) {
        const file = el.files[0];
        const name = `ava_${Date.now()}.jpg`;
        await sb.storage.from('audio_messages').upload(name, file);
        user.avatar = `${SB_URL}/storage/v1/object/public/audio_messages/${name}`;
        localStorage.setItem('x_user', JSON.stringify(user));
        location.reload();
    }
    
    function changeBg(el) {
        const reader = new FileReader();
        reader.onload = (e) => {
            localStorage.setItem('x_bg', e.target.result);
            document.body.style.backgroundImage = `url(${e.target.result})`;
        };
        reader.readAsDataURL(el.files[0]);
    }

    function logout() { localStorage.removeItem('x_user'); location.reload(); }

    // Z…ông
    function startCall() {
        document.getElementById('call-overlay').style.display = 'block';
        const domain = 'meet.jit.si';
        const options = {
            roomName: 'XCall_' + room,
            parentNode: document.querySelector('#jitsi-frame'),
            userInfo: { displayName: user.nick }
        };
        new JitsiMeetExternalAPI(domain, options);
    }
    function endCall() {
        document.getElementById('call-overlay').style.display = 'none';
        document.querySelector('#jitsi-frame').innerHTML = '';
    }

    // Enter il…ô g√∂nd…ôr
    document.getElementById('msgInp').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendText();
    });

    // Mesaj silm…ô (Simulyasiya)
    async function delMsg(id, nick) {
        if(nick === user.nick && confirm("Silinsin?")) {
            await sb.from('messages').delete().eq('id', id);
            document.getElementById('chat-container').innerHTML = ''; // Sad…ô yenil…ôm…ô
            loadMsgs();
        }
    }
    
    // Reaksiya (Simulyasiya)
    async function addReact(id, content) {
        try {
            let json = JSON.parse(content);
            json.reaction = json.reaction === '‚ù§Ô∏è' ? '' : '‚ù§Ô∏è';
            await sb.from('messages').update({ content: JSON.stringify(json) }).eq('id', id);
            loadMsgs(); // Anlƒ±q yenil…ôm…ôk √º√ß√ºn
        } catch(e){}
    }
</script>
</body>
</html>
 
