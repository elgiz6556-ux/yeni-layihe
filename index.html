<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>X-Chat Ultimate PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --bg: #0b0d10; --panel: #16191f; --blue: #3b82f6; 
            --me: #2b5278; --other: #1c2128; --text: #ffffff; 
        }
        .theme-blue { --bg: #0a192f; --panel: #112240; --me: #233554; --blue: #64ffda; }
        .theme-purple { --bg: #1a1025; --panel: #2d1b3d; --me: #4b2d61; --blue: #bd93f9; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100dvh; overflow: hidden; transition: 0.3s; }

        /* GÄ°RÄ°Å EKRANI */
        #loginPage { 
            position: fixed; inset: 0; background: var(--bg); z-index: 5000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px;
        }
        .login-card { background: var(--panel); width: 100%; max-width: 400px; padding: 30px; border-radius: 28px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .ava-picker { width: 100px; height: 100px; border-radius: 50%; background: #000; margin: 0 auto 20px; border: 2px dashed var(--blue); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: pointer; }
        .ava-picker img { width: 100%; height: 100%; object-fit: cover; }
        .ava-picker span { font-size: 30px; }

        .login-card input { width: 100%; background: #000; border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 14px; border-radius: 12px; margin-bottom: 20px; outline: none; font-size: 16px; }
        .login-btn { width: 100%; background: var(--blue); color: #fff; border: none; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 16px; }

        /* ÆSAS TÆTBÄ°Q */
        #mainApp { display: none; height: 100%; flex-direction: column; }
        header { background: var(--panel); padding: max(10px, env(safe-area-inset-top)) 15px 10px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); }
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg-box { max-width: 82%; padding: 10px 14px; border-radius: 18px; position: relative; }
        .me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; background: var(--other); border-bottom-left-radius: 4px; }

        .footer { background: var(--panel); padding: 10px 10px calc(env(safe-area-inset-bottom) + 10px); display: flex; align-items: center; gap: 8px; border-top: 1px solid rgba(255,255,255,0.05); }
        .inp-wrap { flex: 1; background: #000; border-radius: 24px; padding: 0 15px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; }
        input#mInp { flex: 1; background: transparent; border: none; color: #fff; padding: 12px 0; outline: none; }

        .btn { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; }
        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; }
        .sheet-overlay.active { display: flex; }
        .sheet { width: 100%; background: var(--panel); border-radius: 20px 20px 0 0; padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        .sheet-btn { width: 100%; padding: 16px; background: rgba(255,255,255,0.05); border: none; color: #fff; border-radius: 14px; margin-bottom: 10px; text-align: left; }
        
        audio { width: 200px; height: 35px; filter: invert(1); }
        img.msg-img { max-width: 100%; border-radius: 12px; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-card">
            <h2>X-Chat-É™ XoÅŸ GÉ™ldin</h2>
            
            <div class="ava-picker" onclick="document.getElementById('avaFile').click()">
                <img id="avaPrev" style="display:none">
                <span id="avaPlus">+</span>
            </div>
            <input type="file" id="avaFile" hidden accept="image/*" onchange="previewAva()">
            
            <input type="text" id="nickInp" placeholder="AdÄ±nÄ±z (Nickname)">
            <button class="login-btn" id="loginBtn" onclick="handleLogin()">Daxil Ol</button>
            <p id="loadingText" style="display:none; font-size:12px; margin-top:10px; opacity:0.7">ÅÉ™kil yÃ¼klÉ™nir...</p>
        </div>
    </div>

    <div id="mainApp">
        <header>
            <div style="display:flex; align-items:center; gap:10px" onclick="openSheet('menuSheet')">
                <img id="myAva" style="width:36px; height:36px; border-radius:50%; border:1px solid var(--blue); object-fit:cover">
                <b id="roomTitle">General</b>
            </div>
            <div style="display:flex; gap:15px; font-size:22px">
                <span onclick="openSheet('themeSheet')">ğŸ¨</span>
            </div>
        </header>

        <div id="chat"></div>

        <div class="footer">
            <span onclick="openSheet('attachSheet')" style="font-size:25px; padding:0 8px; color:var(--blue)">+</span>
            <button class="btn" id="micBtn" style="background:#1e2126; color:var(--blue)" onclick="handleVoice()">ğŸ™ï¸</button>
            <div class="inp-wrap">
                <input type="text" id="mInp" placeholder="Mesaj..." onkeypress="if(event.key==='Enter') sendText()">
            </div>
            <button class="btn" style="background:var(--blue); color:#fff" onclick="sendText()">â¤</button>
        </div>
    </div>

    <div id="menuSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" style="background:var(--blue)" onclick="goGlobal()">ğŸŒ Qlobal Ã‡at</button>
        <button class="sheet-btn" onclick="changeRoom()">ğŸ”’ Otaq DÉ™yiÅŸ</button>
        <button class="sheet-btn" style="color:#ef4444" onclick="logout()">ğŸ›‘ Ã‡Ä±xÄ±ÅŸ</button>
    </div></div>

    <div id="themeSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="setTheme('')">ğŸŒ‘ Standart</button>
        <button class="sheet-btn" onclick="setTheme('theme-blue')">ğŸŒŠ Okean</button>
        <button class="sheet-btn" onclick="setTheme('theme-purple')">ğŸ”® BÉ™nÃ¶vÅŸÉ™yi</button>
    </div></div>

    <div id="attachSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="document.getElementById('fInp').click()">ğŸ–¼ ÅÉ™kil</button>
        <button class="sheet-btn" onclick="sendLoc()">ğŸ“ MÉ™kan</button>
    </div></div>

    <div id="msgSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="startEdit()">âœï¸ RedaktÉ™</button>
        <button class="sheet-btn" style="color:#ef4444" onclick="deleteMsg()">ğŸ—‘ Sil</button>
    </div></div>

    <div id="dmSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <h3 id="dmTargetName" style="text-align:center"></h3>
        <button id="dmBtn" class="sheet-btn" style="background:var(--blue); text-align:center">ğŸ’¬ Mesaj Yaz</button>
    </div></div>

    <input type="file" id="fInp" hidden accept="image/*" onchange="uploadFile()">

<script>
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user'));
    let room = 'General', selectedId, isEditing = false, mediaRecorder, chunks = [];
    let uploadedAvaUrl = "";

    function checkLogin() {
        if(user) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            document.getElementById('myAva').src = user.ava;
            initChat();
        }
    }

    async function previewAva() {
        const file = document.getElementById('avaFile').files[0];
        if(!file) return;
        
        // Ã–nizlÉ™mÉ™ Ã¼Ã§Ã¼n
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('avaPrev').src = e.target.result;
            document.getElementById('avaPrev').style.display = 'block';
            document.getElementById('avaPlus').style.display = 'none';
        }
        reader.readAsDataURL(file);

        // Supabase-É™ yÃ¼klÉ™
        document.getElementById('loadingText').style.display = 'block';
        document.getElementById('loginBtn').disabled = true;
        
        const fileName = `ava_${Date.now()}.png`;
        const { data, error } = await sb.storage.from('audio_messages').upload(fileName, file);
        
        if(!error) {
            uploadedAvaUrl = `${SB_URL}/storage/v1/object/public/audio_messages/${fileName}`;
            document.getElementById('loadingText').innerText = "âœ… ÅÉ™kil hazÄ±rdÄ±r!";
        }
        document.getElementById('loginBtn').disabled = false;
    }

    function handleLogin() {
        const nick = document.getElementById('nickInp').value.trim();
        if(!nick) return alert('Ad yazÄ±n!');
        
        const ava = uploadedAvaUrl || `https://ui-avatars.com/api/?name=${nick}&background=random`;
        user = { nick, ava };
        localStorage.setItem('x_user', JSON.stringify(user));
        location.reload();
    }

    // Ã‡at FunksiyalarÄ±
    function initChat() {
        document.body.className = localStorage.getItem('theme') || '';
        loadMsgs();
        sb.channel('updates').on('postgres_changes',{event:'*',schema:'public',table:'messages'},() => loadMsgs()).subscribe();
    }

    async function loadMsgs() {
        const { data } = await sb.from('messages').select('*').eq('group_id', room).order('created_at',{ascending:true});
        const c = document.getElementById('chat'); c.innerHTML = '';
        data.forEach(m => {
            const isMe = m.nickname === user.nick;
            let body = '', j;
            try { j = JSON.parse(m.content);
                if(j.type==='audio') body = `<audio src="${j.url}" controls></audio>`;
                else if(j.type==='image') body = `<img src="${j.url}" class="msg-img">`;
                else if(j.type==='loc') body = `<a href="${j.url}" target="_blank" style="color:var(--blue)">ğŸ“ MÉ™kan</a>`;
                else body = j.text;
            } catch { body = m.content; j={}; }

            const div = document.createElement('div');
            div.className = `msg-box ${isMe ? 'me' : 'other'}`;
            div.innerHTML = `
                <div ontouchstart="hStart('${m.id}')" ontouchend="hEnd()" onmousedown="hStart('${m.id}')" onmouseup="hEnd()">
                    ${!isMe ? `<b onclick="openDM('${m.nickname}')" style="color:var(--blue);font-size:11px;display:block;margin-bottom:2px">ğŸ‘¤ ${m.nickname}</b>` : ''}
                    ${body}
                    <div style="font-size:10px;opacity:0.4;text-align:right;margin-top:3px">${new Date(m.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                </div>`;
            c.appendChild(div);
        });
        c.scrollTop = c.scrollHeight;
    }

    async function sendText() {
        const i = document.getElementById('mInp'); if(!i.value.trim()) return;
        const val = i.value; i.value = '';
        await sb.from('messages').insert([{ nickname:user.nick, group_id:room, content: JSON.stringify({text:val, type:'text'}) }]);
    }

    async function handleVoice() {
        const btn = document.getElementById('micBtn');
        if(!mediaRecorder || mediaRecorder.state === 'inactive') {
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder = new MediaRecorder(s); chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(chunks, {type:'audio/webm'});
                const name = `v_${Date.now()}.webm`;
                await sb.storage.from('audio_messages').upload(name, blob);
                const url = `${SB_URL}/storage/v1/object/public/audio_messages/${name}`;
                await sb.from('messages').insert([{ nickname:user.nick, group_id:room, content: JSON.stringify({url, type:'audio'}) }]);
            };
            mediaRecorder.start(); btn.style.background = '#ef4444';
        } else { mediaRecorder.stop(); btn.style.background = '#1e2126'; }
    }

    function openDM(target) {
        document.getElementById('dmTargetName').innerText = target;
        document.getElementById('dmBtn').onclick = () => {
            room = 'DM_' + [user.nick, target].sort().join('_');
            document.getElementById('roomTitle').innerText = 'ğŸ‘¤ ' + target;
            closeSheets(); loadMsgs();
        };
        openSheet('dmSheet');
    }

    function logout() { localStorage.clear(); location.reload(); }
    function goGlobal() { room = 'General'; document.getElementById('roomTitle').innerText = 'General'; closeSheets(); loadMsgs(); }
    function openSheet(id) { document.getElementById(id).classList.add('active'); }
    function closeSheets() { document.querySelectorAll('.sheet-overlay').forEach(s => s.classList.remove('active')); }
    function hStart(id) { selectedId = id; holdTimer = setTimeout(() => openSheet('msgSheet'), 500); }
    function hEnd() { clearTimeout(holdTimer); }
    function setTheme(t) { document.body.className = t; localStorage.setItem('theme', t); closeSheets(); }

    checkLogin();
</script>
</body>
</html>
 
