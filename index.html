<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X-Chat Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://meet.jit.si/external_api.js'></script>

    <style>
        :root {
            --primary: #4e54c8;
            --secondary: #8f94fb;
            --bg: #1a1a2e;
            --surface: #16213e;
            --text: #fff;
            --my-msg: #4e54c8;
            --glass: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; background-size: cover; background-position: center; transition: 0.3s; }

        /* --- LOGIN --- */
        #auth-screen { position: fixed; inset: 0; background: #0f3460; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .inp { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: none; background: rgba(0,0,0,0.3); color: white; outline: none; font-size: 16px; }
        .btn { width: 100%; padding: 15px; background: linear-gradient(to right, var(--primary), var(--secondary)); border: none; color: white; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }

        /* --- APP HEADER --- */
        .header { padding: 15px; background: rgba(22, 33, 62, 0.95); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 100; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); cursor: pointer; }
        .status-dot { width: 10px; height: 10px; background: #00b894; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        .header-actions { display: flex; gap: 10px; }
        .icon-btn { background: var(--glass); border: none; color: white; width: 40px; height: 40px; border-radius: 12px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        
        /* --- SIDEBAR & ROOMS --- */
        #room-panel { position: fixed; top: 0; left: -100%; width: 80%; height: 100%; background: var(--surface); z-index: 200; transition: 0.3s; padding: 20px; box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
        #room-panel.active { left: 0; }
        .room-item { padding: 15px; margin-bottom: 10px; background: var(--glass); border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .room-item.active { background: var(--primary); }

        /* --- CHAT --- */
        #chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .msg-row { display: flex; flex-direction: column; max-width: 80%; position: relative; }
        .msg-row.my { align-self: flex-end; align-items: flex-end; }
        
        .msg-bubble { padding: 12px 16px; border-radius: 18px; background: var(--surface); position: relative; font-size: 15px; line-height: 1.4; min-width: 100px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .msg-row.my .msg-bubble { background: linear-gradient(135deg, var(--primary), var(--secondary)); border-bottom-right-radius: 4px; }
        .msg-row:not(.my) .msg-bubble { border-bottom-left-radius: 4px; background: #242b3d; }

        .sender { font-size: 11px; opacity: 0.7; margin-bottom: 4px; display: block; }
        .meta { font-size: 10px; opacity: 0.5; display: flex; justify-content: flex-end; margin-top: 5px; gap: 5px; }
        
        /* Multimedia */
        .msg-img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        audio { height: 30px; width: 200px; filter: invert(1); margin-top: 5px; }

        /* Reaksiyalar */
        .reactions { position: absolute; bottom: -10px; right: 0; background: #2d3436; border-radius: 10px; padding: 2px 6px; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: none; }
        .has-reaction .reactions { display: block; }

        /* --- INPUT --- */
        .input-bar { padding: 10px; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); display: flex; align-items: center; gap: 8px; border-top: 1px solid rgba(255,255,255,0.05); }
        .input-wrap { flex: 1; background: rgba(255,255,255,0.1); border-radius: 25px; padding: 5px 15px; display: flex; align-items: center; }
        .input-wrap input { flex: 1; background: transparent; border: none; color: white; padding: 10px 0; outline: none; font-size: 16px; }
        
        /* Z…ông Modal */
        #call-frame { position: fixed; inset: 0; z-index: 1000; background: #000; display: none; }
        .close-call { position: absolute; top: 20px; right: 20px; z-index: 1001; background: red; color: white; border: none; padding: 10px 20px; border-radius: 20px; }

        /* Tools Menu */
        .tools-menu { position: fixed; bottom: 80px; left: 10px; background: var(--surface); padding: 15px; border-radius: 15px; display: none; flex-direction: column; gap: 10px; border: 1px solid var(--glass); }
        
        .mic-active { animation: pulse 1s infinite; background: #ff4757 !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="card">
        <h2 style="color:var(--secondary)">X-CHAT ID</h2>
        <input type="text" id="logNick" class="inp" placeholder="Adƒ±nƒ±z">
        <input type="password" id="logPass" class="inp" placeholder="≈ûifr…ô">
        <button class="btn" onclick="login()">Gƒ∞Rƒ∞≈û</button>
    </div>
</div>

<div id="app" style="display:none; height:100%;">
    
    <div class="header">
        <div class="user-info" onclick="toggleSidebar()">
            <img id="myAvatar" class="avatar" src="">
            <div>
                <h3 style="margin:0; font-size:16px;" id="headerRoomName">General</h3>
                <span style="font-size:12px; color:#00b894;">‚óè <span id="onlineCount">1</span> Online</span>
            </div>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="startCall()">üìû</button>
            <button class="icon-btn" onclick="toggleTools()">‚öôÔ∏è</button>
        </div>
    </div>

    <div id="room-panel">
        <h3 style="margin-top:0">Otaqlar</h3>
        <div class="room-item active" onclick="switchRoom('General')">üåê General</div>
        <div class="room-item" onclick="createPrivateRoom()">üîí ≈û…ôxsi Otaq (+Kod)</div>
        <hr style="border-color:rgba(255,255,255,0.1)">
        <h3>Fon D…ôyi≈ü</h3>
        <input type="file" id="bgInput" onchange="changeBackground(this)" style="color:white">
    </div>

    <div id="chat-area" onclick="document.getElementById('room-panel').classList.remove('active')"></div>

    <div class="input-bar">
        <button class="icon-btn" onclick="document.getElementById('fileInput').click()">üìé</button>
        <button class="icon-btn" id="micBtn" onclick="toggleMic()">üé§</button>
        <div class="input-wrap">
            <input type="text" id="msgInp" placeholder="Mesaj..." onkeypress="if(event.key=='Enter') sendMsg('text')">
        </div>
        <button class="icon-btn" style="background:var(--primary)" onclick="sendMsg('text')">üöÄ</button>
    </div>

    <input type="file" id="fileInput" hidden onchange="sendFile(this)">
    <input type="file" id="avatarInput" hidden accept="image/*" onchange="uploadAvatar(this)">
    
    <div class="tools-menu" id="toolsMenu">
        <button class="btn" onclick="document.getElementById('avatarInput').click()">Profil ≈û…ôklini D…ôyi≈ü</button>
        <button class="btn" onclick="logout()" style="background:#ff4757">√áƒ±xƒ±≈ü</button>
    </div>
</div>

<div id="call-frame">
    <button class="close-call" onclick="endCall()">Z…ôngi Bitir</button>
    <div id="jitsi-container" style="height:100%; width:100%;"></div>
</div>

<script>
    // --- SUPABASE CONFIG ---
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user')) || null;
    let room = 'General';
    let roomPass = null; // Otaq ≈üifr…ôsi
    let mediaRec, chunks = [];

    // --- 1. Gƒ∞Rƒ∞≈û Sƒ∞STEMƒ∞ ---
    if(user) startApp();

    function login() {
        const nick = document.getElementById('logNick').value.trim();
        const pass = document.getElementById('logPass').value.trim();
        if(!nick || !pass) return alert('M…ôlumatlarƒ± doldur!');
        
        user = { nick, pass, avatar: `https://ui-avatars.com/api/?name=${nick}&background=random` };
        localStorage.setItem('x_user', JSON.stringify(user));
        startApp();
    }

    function startApp() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        document.getElementById('myAvatar').src = user.avatar;
        
        // Arxa fonu b…ôrpa et
        const bg = localStorage.getItem('x_bg');
        if(bg) document.body.style.backgroundImage = `url(${bg})`;
        
        loadMessages();
        setupRealtime();
    }

    function logout() {
        localStorage.removeItem('x_user');
        location.reload();
    }

    // --- 2. REALTIME & MESSAGING ---
    function setupRealtime() {
        // Mesajlarƒ± izl…ô
        sb.channel('public:messages')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, payload => {
            if(payload.eventType === 'INSERT' && payload.new.group_id === room) renderMsg(payload.new);
            if(payload.eventType === 'DELETE') document.getElementById(`row-${payload.old.id}`)?.remove();
            if(payload.eventType === 'UPDATE') updateMsgUI(payload.new); // Reaksiya √º√ß√ºn
        })
        .subscribe();

        // Online ƒ∞nsanlar (Presence)
        const presence = sb.channel('online_users');
        presence.on('presence', { event: 'sync' }, () => {
            const count = Object.keys(presence.presenceState()).length;
            document.getElementById('onlineCount').innerText = count;
        }).subscribe(async (status) => {
            if (status === 'SUBSCRIBED') await presence.track({ user: user.nick });
        });
    }

    async function loadMessages() {
        document.getElementById('chat-area').innerHTML = '';
        const { data } = await sb.from('messages').select('*').eq('group_id', room).order('created_at', {ascending:true});
        if(data) data.forEach(renderMsg);
    }

    // Mesaj Render (√áox Funksiyalƒ±)
    function renderMsg(msg) {
        if(document.getElementById(`row-${msg.id}`)) return;
        
        // K√∂hn…ô vs Yeni formatƒ± d…ôst…ôkl…ôm…ôk √º√ß√ºn
        let content = msg.content; 
        let type = 'text';
        let reaction = '';

        // JSON formatƒ±nƒ± yoxlayƒ±rƒ±q (∆èg…ôr yeni mesajdƒ±rsa)
        try {
            const parsed = JSON.parse(msg.content);
            if(parsed.text) {
                content = parsed.text;
                type = parsed.type || 'text';
                reaction = parsed.reaction || '';
            }
        } catch(e) {
            // K√∂hn…ô d√ºz m…ôtn mesajƒ±
        }

        // ≈ûifr…ôli Otaq M…ôntiqi (Client Side)
        if(roomPass && msg.group_id === room && type === 'system_pass') {
             // Sistem mesajlarƒ±nƒ± gizl…ôt
             return;
        }

        const isMy = msg.nickname === user.nick;
        const div = document.createElement('div');
        div.id = `row-${msg.id}`;
        div.className = `msg-row ${isMy ? 'my' : ''}`;
        
        // M…ôzmunu hazƒ±rla
        let bodyHtml = content;
        if(type === 'image') bodyHtml = `<img src="${content}" class="msg-img" onclick="window.open(this.src)">`;
        if(type === 'audio') bodyHtml = `<audio src="${content}" controls></audio>`;
        if(content.startsWith('http') && !type) bodyHtml = `<a href="${content}" target="_blank" style="color:#fff">Link</a>`;

        div.innerHTML = `
            <div class="msg-bubble" ondblclick="addReaction('${msg.id}', '${msg.content}')" oncontextmenu="deleteMsg('${msg.id}', '${msg.nickname}'); return false;">
                <span class="sender">${msg.nickname}</span>
                ${bodyHtml}
                <div class="meta">
                    ${new Date(msg.created_at).getHours()}:${String(new Date(msg.created_at).getMinutes()).padStart(2,'0')}
                    ${isMy ? '‚úì‚úì' : ''}
                </div>
                <div class="reactions ${reaction ? 'has-reaction' : ''}">${reaction}</div>
            </div>
        `;
        
        document.getElementById('chat-area').appendChild(div);
        document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
    }

    // --- 3. G√ñND∆èRM∆è (M…ôtn, ≈û…ôkil, S…ôs) ---
    async function sendMsg(type, payload = null) {
        let content = payload;
        if(type === 'text') {
            const inp = document.getElementById('msgInp');
            if(!inp.value.trim()) return;
            content = inp.value;
            inp.value = '';
        }

        // B√ºt√ºn m…ôlumatƒ± JSON kimi paketl…ôyirik
        const msgData = JSON.stringify({
            text: content,
            type: type,
            reaction: ''
        });

        await sb.from('messages').insert([{
            nickname: user.nick,
            group_id: room,
            content: msgData // Bazada 'content' s√ºtununa JSON yazƒ±rƒ±q
        }]);
    }

    // Fayl Y√ºkl…ôm…ô (≈û…ôkil)
    async function sendFile(el) {
        const file = el.files[0];
        if(!file) return;
        const url = await uploadToStorage(file);
        if(url) sendMsg('image', url);
    }

    // S…ôsli Mesaj
    async function toggleMic() {
        const btn = document.getElementById('micBtn');
        if(!mediaRec || mediaRec.state === 'inactive') {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                mediaRec = new MediaRecorder(stream);
                chunks = [];
                mediaRec.ondataavailable = e => chunks.push(e.data);
                mediaRec.onstop = async () => {
                    const blob = new Blob(chunks, {type:'audio/webm'});
                    const url = await uploadToStorage(blob, 'voice.webm');
                    if(url) sendMsg('audio', url);
                    btn.classList.remove('mic-active');
                };
                mediaRec.start();
                btn.classList.add('mic-active');
            } catch(e) { alert('Mikrofon icaz…ôsi yoxdur!'); }
        } else {
            mediaRec.stop();
        }
    }

    async function uploadToStorage(file, name = null) {
        const fileName = name || `file_${Date.now()}_${Math.random()}.jpg`;
        const { data, error } = await sb.storage.from('audio_messages').upload(fileName, file);
        if(data) return `${SB_URL}/storage/v1/object/public/audio_messages/${fileName}`;
        return null;
    }

    // --- 4. FUNKSƒ∞ONALLIQLAR (Silm…ô, Reaksiya, Z…ông, Otaq) ---
    
    // Mesaj Silm…ô (√úst√ºn…ô basƒ±b saxlayanda)
    async function deleteMsg(id, sender) {
        if(sender === user.nick && confirm('Mesaj silinsin?')) {
            await sb.from('messages').delete().eq('id', id);
        }
    }

    // Reaksiya (ƒ∞ki d…ôf…ô toxunanda)
    async function addReaction(id, oldContentStr) {
        try {
            let data = JSON.parse(oldContentStr);
            // Sad…ô toggle: ‚ù§Ô∏è varrsa sil, yoxdursa qoy
            data.reaction = data.reaction === '‚ù§Ô∏è' ? '' : '‚ù§Ô∏è';
            
            await sb.from('messages').update({ content: JSON.stringify(data) }).eq('id', id);
        } catch(e) {
            // K√∂hn…ô mesajlara reaksiya veril…ô bilmir (schema f…ôrqi)
        }
    }
    
    // UI Update (Reaksiya √º√ß√ºn)
    function updateMsgUI(newMsg) {
        const row = document.getElementById(`row-${newMsg.id}`);
        if(row) {
            row.remove(); // K√∂hn…ôni silib yenisini render edirik
            renderMsg(newMsg);
        }
    }

    // Z…ông (Jitsi Meet)
    function startCall() {
        const domain = 'meet.jit.si';
        const options = {
            roomName: 'XChat_' + room + '_' + Date.now(), // Unikal otaq adƒ±
            width: '100%',
            height: '100%',
            parentNode: document.querySelector('#jitsi-container'),
            userInfo: { displayName: user.nick }
        };
        document.getElementById('call-frame').style.display = 'block';
        new JitsiMeetExternalAPI(domain, options);
    }

    function endCall() {
        document.getElementById('jitsi-container').innerHTML = ''; // Z…ôngi √∂ld√ºr
        document.getElementById('call-frame').style.display = 'none';
    }

    // Profil ≈û…ôkli
    async function uploadAvatar(el) {
        const url = await uploadToStorage(el.files[0]);
        if(url) {
            user.avatar = url;
            localStorage.setItem('x_user', JSON.stringify(user));
            document.getElementById('myAvatar').src = url;
        }
    }

    // Arxa Fon
    function changeBackground(el) {
        const file = el.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            document.body.style.backgroundImage = `url(${e.target.result})`;
            localStorage.setItem('x_bg', e.target.result);
        };
        reader.readAsDataURL(file);
    }

    // Otaq D…ôyi≈üm…ô v…ô ≈ûifr…ôli Otaq
    function switchRoom(newRoom) {
        room = newRoom;
        roomPass = null;
        document.getElementById('headerRoomName').innerText = room;
        document.getElementById('room-panel').classList.remove('active');
        loadMessages();
    }

    function createPrivateRoom() {
        const name = prompt("Otaq adƒ±:");
        const pass = prompt("Otaq √º√ß√ºn ≈üifr…ô t…ôyin edin:");
        if(name && pass) {
            // ≈ûifr…ôni yoxlamaq √º√ß√ºn (Sad…ô versiya)
            const entered = prompt(`"${name}" otaƒüƒ±na girm…ôk √º√ß√ºn ≈üifr…ô:`);
            if(entered === pass) {
                switchRoom(name);
                roomPass = pass;
                alert("Otaƒüa daxil oldunuz. Ba≈üqalarƒ± ≈üifr…ôni bilm…ôd…ôn gir…ô bilm…ôz (Simulyasiya).");
            } else {
                alert("≈ûifr…ô s…ôhvdir!");
            }
        }
    }

    // UI Tools
    function toggleSidebar() { document.getElementById('room-panel').classList.toggle('active'); }
    function toggleTools() { 
        const m = document.getElementById('toolsMenu');
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
    }
</script>

</body>
</html>
 
