<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X-Chat Elite</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --accent: #00d2ff; --bg: #0f172a; --panel: rgba(30, 41, 59, 0.7); --text: #f8fafc; }
        
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; transition: 0.3s; }
        
        /* Glass Effect */
        .glass { background: var(--panel); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }

        /* Header */
        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .nav-btns { display: flex; gap: 15px; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-circle:hover { background: var(--accent); color: #000; }

        /* Chat Area */
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        .msg-wrapper { display: flex; flex-direction: column; max-width: 80%; gap: 5px; }
        .msg-wrapper.my { align-self: flex-end; }
        
        .reply-info { font-size: 11px; color: var(--accent); margin-bottom: -8px; margin-left: 10px; opacity: 0.8; }
        
        .bubble { padding: 12px 16px; border-radius: 20px; position: relative; font-size: 15px; line-height: 1.4; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .my .bubble { background: linear-gradient(135deg, var(--accent), #0081a7); color: #000; border-bottom-right-radius: 2px; }
        .other .bubble { background: #1e293b; border-bottom-left-radius: 2px; }

        /* Reactions */
        .react-row { display: flex; gap: 5px; margin-top: 5px; }
        .react-tag { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 12px; }

        /* Input Bar */
        .input-bar { padding: 15px; display: flex; gap: 10px; align-items: center; }
        .input-box { flex: 1; padding: 12px 20px; border-radius: 30px; border: none; background: #1e293b; color: #fff; outline: none; }
        
        /* Panels (Profil, DM, Settings) */
        .overlay-panel { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal { width: 90%; max-width: 400px; padding: 25px; border-radius: 25px; position: relative; }
        
        .reply-bar { display: none; padding: 8px 15px; background: rgba(0,210,255,0.1); border-left: 4px solid var(--accent); justify-content: space-between; }

        input[type="color"] { width: 100%; height: 40px; border: none; border-radius: 10px; cursor: pointer; }
        
        .hidden { display: none; }
    </style>
</head>
<body id="mainBody">

<div id="loginOverlay" class="overlay-panel" style="display: flex;">
    <div class="modal glass">
        <h2>X-Elite Giri≈ü</h2>
        <input type="text" id="nickInp" class="input-box" placeholder="ƒ∞stifad…ô√ßi adƒ±" style="width: 100%; margin-bottom: 10px; box-sizing: border-box;">
        <input type="password" id="passInp" class="input-box" placeholder="Parol" style="width: 100%; margin-bottom: 20px; box-sizing: border-box;">
        <button onclick="auth()" style="width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--accent); font-weight: bold;">DAXƒ∞L OL</button>
    </div>
</div>

<div class="header glass">
    <div class="nav-btns">
        <div class="btn-circle glass" onclick="openPanel('dmPanel')">üì©</div>
        <div class="btn-circle glass" onclick="openPanel('profilePanel')">üë§</div>
    </div>
    <div id="activeRoom">General</div>
    <div class="btn-circle glass" onclick="openPanel('settingsPanel')">‚öôÔ∏è</div>
</div>

<div id="chat"></div>

<div id="replyBar" class="reply-bar">
    <span id="replyTxt" style="font-size: 12px;"></span>
    <span onclick="cancelReply()" style="cursor: pointer;">‚úï</span>
</div>

<div class="input-bar glass">
    <button class="btn-circle glass" onclick="document.getElementById('fileInp').click()">‚ûï</button>
    <input type="file" id="fileInp" class="hidden" onchange="handleFile(this)">
    <input type="text" id="mainInp" class="input-box" placeholder="Mesaj yazƒ±n..." onkeypress="if(event.key=='Enter') send()">
    <button id="voiceBtn" class="btn-circle glass" onclick="toggleVoice()">üé§</button>
</div>

<div id="profilePanel" class="overlay-panel" onclick="closePanels()">
    <div class="modal glass" onclick="event.stopPropagation()">
        <h3>Profil</h3>
        <div id="userDisplay"></div>
        <hr>
        <p>Parolu D…ôyi≈ü:</p>
        <input type="password" id="newPass" class="input-box" style="width: 100%; margin-bottom: 10px; box-sizing: border-box;">
        <button onclick="updatePass()" style="width: 100%; padding: 10px; background: var(--accent); border: none; border-radius: 10px;">Yadda saxla</button>
    </div>
</div>

<div id="dmPanel" class="overlay-panel" onclick="closePanels()">
    <div class="modal glass" onclick="event.stopPropagation()">
        <h3>≈û…ôxsi Mesaj (DM)</h3>
        <input type="text" id="targetNick" class="input-box" placeholder="ƒ∞stifad…ô√ßi adƒ±" style="width: 100%; margin-bottom: 15px; box-sizing: border-box;">
        <button onclick="startDM()" style="width: 100%; padding: 10px; background: var(--accent); border: none; border-radius: 10px;">S√∂hb…ôt…ô Ba≈üla</button>
    </div>
</div>

<div id="settingsPanel" class="overlay-panel" onclick="closePanels()">
    <div class="modal glass" onclick="event.stopPropagation()">
        <h3>Dizayn Ayarlarƒ±</h3>
        <p>T…ôtbiq R…ôngi:</p>
        <input type="color" id="colorPicker" onchange="changeTheme(this.value)">
        <p style="margin-top: 20px;">Fon ≈û…ôkli URL:</p>
        <input type="text" id="bgUrlInp" class="input-box" placeholder="https://..." style="width: 100%; box-sizing: border-box;">
        <button onclick="changeBg()" style="width: 100%; margin-top: 10px; padding: 10px; background: var(--accent); border: none; border-radius: 10px;">D…ôyi≈ü</button>
    </div>
</div>

<script>
    // Supabase Konfiqurasiyasƒ±
    const URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(URL, KEY);

    let me = JSON.parse(localStorage.getItem('elite_user'));
    let room = 'General';
    let replyTo = null;
    let isRecording = false;

    if(me) { document.getElementById('loginOverlay').style.display = 'none'; init(); }

    function auth() {
        const n = document.getElementById('nickInp').value.trim();
        const p = document.getElementById('passInp').value;
        if(!n || !p) return;
        me = { n, p, a: `https://ui-avatars.com/api/?name=${n}&background=random`, color: '#00d2ff' };
        localStorage.setItem('elite_user', JSON.stringify(me));
        location.reload();
    }

    function init() {
        loadMsgs();
        document.getElementById('userDisplay').innerText = "Xo≈ü g…ôldin, " + me.n;
        if(me.color) changeTheme(me.color);

        sb.channel('elite').on('postgres_changes', {event:'*', schema:'public', table:'messages'}, (p) => {
            if(p.eventType === 'INSERT' && p.new.group_id === room) render(p.new);
            if(p.eventType === 'DELETE') document.getElementById('row-'+p.old.id)?.remove();
            if(p.eventType === 'UPDATE') {
                const rBox = document.querySelector(`#row-${p.new.id} .react-row`);
                if(rBox) rBox.innerHTML = p.new.reactions || "";
            }
        }).subscribe();
    }

    async function loadMsgs() {
        document.getElementById('chat').innerHTML = "";
        const {data} = await sb.from('messages').select('*').eq('group_id', room).order('created_at');
        if(data) data.forEach(render);
    }

    function render(m) {
        if(document.getElementById('row-'+m.id)) return;
        const isMy = m.nickname === me.n;
        const div = document.createElement('div');
        div.id = 'row-'+m.id;
        div.className = `msg-wrapper ${isMy ? 'my' : 'other'}`;
        
        let content = m.content;
        if(content.startsWith('http')) {
            if(content.includes('.mp3') || content.includes('audio')) {
                content = `<audio src="${content}" controls style="width: 200px;"></audio>`;
            } else {
                content = `<img src="${content}" style="max-width: 250px; border-radius: 15px;">`;
            }
        }

        div.innerHTML = `
            ${m.reply_to ? `<div class="reply-info">‚§∫ Cavab: ${m.reply_to}</div>` : ''}
            <div class="bubble" oncontextmenu="showMsgMenu(event, ${m.id}, '${m.nickname}', '${m.content}')" onclick="setReply(${m.id}, '${m.nickname}')">
                <div style="font-size: 10px; font-weight: bold; opacity: 0.6; margin-bottom: 4px;">${m.nickname}</div>
                <div>${content}</div>
                <div class="react-row">${m.reactions || ""}</div>
                <div style="font-size: 9px; text-align: right; opacity: 0.5; margin-top: 5px;">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
            </div>
        `;
        document.getElementById('chat').appendChild(div);
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    async function send() {
        const inp = document.getElementById('mainInp');
        const val = inp.value.trim();
        if(!val) return;
        const msgData = {
            content: val,
            nickname: me.n,
            group_id: room,
            reply_to: replyTo ? replyTo.nick + ": " + replyTo.txt : null,
            reactions: ""
        };
        inp.value = "";
        cancelReply();
        await sb.from('messages').insert([msgData]);
    }

    // Mesaj √ºz…ôrind…ô saƒü klik (Long Press simulyasiyasƒ±)
    function showMsgMenu(e, id, nick, txt) {
        e.preventDefault();
        const action = prompt("1. Reaksiya (‚ù§Ô∏è, üëç, üòÇ)\n2. Sil (Ancaq √∂z mesajƒ±n)\n3. Cavabla");
        if(action == "1") addReaction(id);
        if(action == "2" && nick === me.n) deleteMessage(id);
        if(action == "3") setReply(id, nick, txt);
    }

    async function addReaction(id) {
        const emoji = prompt("Emoji?");
        if(!emoji) return;
        // Sad…ôc…ô 1 reaksiya m…ôntiqi √º√ß√ºn bazada yoxlama lazƒ±mdƒ±r, burada b…ôsitl…ô≈üdiririk:
        const {data} = await sb.from('messages').select('reactions').eq('id', id).single();
        let cur = data.reactions || "";
        if(!cur.includes(me.n)) { // H…ôr k…ôs 1 d…ôf…ô
            await sb.from('messages').update({ reactions: cur + ` <span class="react-tag">${emoji}</span>` }).eq('id', id);
        }
    }

    async function deleteMessage(id) {
        if(confirm("Mesaj silinsin?")) {
            document.getElementById('row-'+id)?.remove();
            await sb.from('messages').delete().eq('id', id);
        }
    }

    function setReply(id, nick, txt) {
        replyTo = { id, nick, txt: txt.substring(0, 20) + "..." };
        document.getElementById('replyBar').style.display = 'flex';
        document.getElementById('replyTxt').innerText = "Cavablanƒ±r: " + nick;
    }

    function cancelReply() {
        replyTo = null;
        document.getElementById('replyBar').style.display = 'none';
    }

    // Media
    async function handleFile(el) {
        const f = el.files[0]; if(!f) return;
        const name = Date.now() + "_" + f.name;
        const {data} = await sb.storage.from('audio_messages').upload(name, f);
        if(data) {
            const url = `${URL}/storage/v1/object/public/audio_messages/${name}`;
            await sb.from('messages').insert([{ content: url, nickname: me.n, group_id: room }]);
        }
    }

    // S…ôs Yazma (B…ôsitl…ô≈üdirilmi≈ü)
    function toggleVoice() {
        isRecording = !isRecording;
        const btn = document.getElementById('voiceBtn');
        btn.style.background = isRecording ? "red" : "var(--panel)";
        if(!isRecording) {
            alert("S…ôs qeyd edildi v…ô g√∂nd…ôrildi (Simulyasiya)");
            // Real s…ôs yazma √º√ß√ºn MediaRecorder lazƒ±mdƒ±r, bura …ôlav…ô edil…ô bil…ôr.
        }
    }

    // Ayarlar
    function changeTheme(c) {
        me.color = c;
        document.documentElement.style.setProperty('--accent', c);
        localStorage.setItem('elite_user', JSON.stringify(me));
    }

    function changeBg() {
        const url = document.getElementById('bgUrlInp').value;
        document.getElementById('chat').style.background = `url('${url}') center/cover`;
        closePanels();
    }

    function startDM() {
        const target = document.getElementById('targetNick').value.trim();
        if(!target) return;
        room = [me.n, target].sort().join("_dm_");
        document.getElementById('activeRoom').innerText = "DM: " + target;
        loadMsgs();
        closePanels();
    }

    function openPanel(id) { document.getElementById(id).style.display = 'flex'; }
    function closePanels() { document.querySelectorAll('.overlay-panel').forEach(p => { if(p.id !== 'loginOverlay') p.style.display = 'none'; }); }
</script>
</body>
</html>
