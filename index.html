<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>X-Chat V9 ULTRA</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0b0d10; --panel: #16191f; --blue: #3b82f6; --me: #2b5278; --other: #1c2128; --text: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER & SEARCH */
        header { background: var(--panel); padding: 45px 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .search-bar { background: rgba(0,0,0,0.3); border: none; color: #fff; padding: 8px 15px; border-radius: 10px; width: 100%; margin-top: 10px; outline: none; font-size: 13px; }

        /* CHAT */
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg-box { max-width: 85%; padding: 10px 14px; border-radius: 18px; position: relative; font-size: 15px; cursor: pointer; transition: 0.2s; }
        .msg-box:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        .me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; background: var(--other); border-bottom-left-radius: 4px; }
        
        .reply-meta { font-size: 11px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 5px; margin-bottom: 5px; border-left: 3px solid var(--blue); opacity: 0.8; }

        /* FOOTER & REPLY UI */
        #replyPreview { display: none; background: #000; padding: 8px 15px; border-top: 2px solid var(--blue); font-size: 12px; justify-content: space-between; align-items: center; }
        .footer { background: var(--panel); padding: 10px 10px 30px; display: flex; align-items: center; gap: 8px; }
        .inp-wrap { flex: 1; background: #000; border-radius: 24px; padding: 0 15px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        #mInp { border: none; background: transparent; color: #fff; padding: 12px 0; flex: 1; outline: none; }

        /* MODALS */
        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; backdrop-filter: blur(5px); }
        .sheet-overlay.active { display: flex; }
        .sheet { width: 100%; background: var(--panel); border-radius: 25px 25px 0 0; padding: 20px; max-height: 80vh; overflow-y: auto; }
        .sheet-btn { width: 100%; padding: 15px; background: rgba(255,255,255,0.05); border: none; color: #fff; border-radius: 12px; margin-bottom: 8px; text-align: left; }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div style="display:flex; align-items:center; gap:10px" onclick="openSheet('settingsSheet')">
                <img id="myAva" style="width:35px; height:35px; border-radius:50%; border:2px solid var(--blue)">
                <b id="roomTitle">Qlobal √áat</b>
            </div>
            <div style="display:flex; gap:15px; font-size:22px">
                <span onclick="openFriends()" style="position:relative">üë•<div id="reqDot" style="display:none; width:8px; height:8px; background:red; border-radius:50%; position:absolute; top:0; right:0"></div></span>
                <span onclick="openRooms()">üè†</span>
            </div>
        </div>
        <input type="text" class="search-bar" id="searchMsgs" placeholder="S√∂hb…ôtd…ô axtar..." oninput="filterMessages()">
    </header>

    <div id="chat"></div>

    <div id="replyPreview">
        <div id="replyText" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:0.7">Cavab verilir...</div>
        <span onclick="cancelReply()" style="color:red; cursor:pointer; font-weight:bold; padding:0 10px">√ó</span>
    </div>

    <div class="footer">
        <span onclick="openSheet('attachSheet')" style="font-size:24px; color:var(--blue); padding:0 10px; cursor:pointer">+</span>
        <div class="inp-wrap">
            <input type="text" id="mInp" placeholder="Mesaj yaz..." onkeypress="if(event.key==='Enter') sendMsg()">
        </div>
        <button onclick="sendMsg()" style="background:var(--blue); border:none; color:white; width:40px; height:40px; border-radius:50%">‚û§</button>
    </div>

    <div id="roomsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Otaqlar</h3>
        <input type="text" class="search-bar" id="searchRooms" placeholder="Otaq axtar..." oninput="filterRooms()" style="margin-bottom:15px">
        <button class="sheet-btn" onclick="createRoom()" style="background:var(--blue); font-weight:bold">‚ûï Yeni (v…ô ya ≈ûifr…ôli) Otaq</button>
        <div id="roomsListArea"></div>
    </div></div>

    <div id="friendsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet" onclick="event.stopPropagation()">
        <h3>Sosial Panel</h3>
        <div id="socialContent">Y√ºkl…ônir...</div>
    </div></div>

    <div id="attachSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="document.getElementById('fInp').click()">üñº ≈û…ôkil G√∂nd…ôr</button>
        <button class="sheet-btn" onclick="sendLoc()">üìç M…ôkan Payla≈ü</button>
    </div></div>

    <div id="settingsSheet" class="sheet-overlay" onclick="closeSheets()"><div class="sheet">
        <button class="sheet-btn" onclick="logout()" style="color:red">üõë √áƒ±xƒ±≈ü</button>
    </div></div>

    <input type="file" id="fInp" hidden accept="image/*" onchange="uploadFile()">

<script>
    const SB_URL = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let user = JSON.parse(localStorage.getItem('x_user'));
    let room = 'General';
    let replyTo = null;
    let allCurrentMsgs = [];
    let rooms = JSON.parse(localStorage.getItem('x_rooms')) || ["General"];

    // Bƒ∞LDƒ∞Rƒ∞≈û ƒ∞CAZ∆èSƒ∞
    if (Notification.permission !== "granted") Notification.requestPermission();

    function checkLogin() {
        if(user) {
            document.getElementById('myAva').src = user.ava;
            loadMsgs();
            listenRealtime();
        } else {
            const n = prompt("Adƒ±nƒ±z:");
            if(!n) return location.reload();
            user = { nick: n, ava: `https://ui-avatars.com/api/?name=${n}&background=random` };
            localStorage.setItem('x_user', JSON.stringify(user));
            location.reload();
        }
    }

    function listenRealtime() {
        sb.channel('main').on('postgres_changes', {event:'INSERT', schema:'public', table:'messages'}, p => {
            const m = p.new;
            if(m.group_id === room) loadMsgs();
            if(m.group_id === 'REQ_'+user.nick) {
                document.getElementById('reqDot').style.display = 'block';
                showNotification("Yeni Dostluq ƒ∞st…ôyi!", `${m.nickname} s…ôn…ô dostluq g√∂nd…ôrdi.`);
            }
            if(m.group_id !== room && m.group_id.startsWith('DM_') && m.nickname !== user.nick) {
                showNotification("Yeni DM!", `${m.nickname}: ${m.content}`);
            }
        }).subscribe();
    }

    function showNotification(title, body) {
        if (Notification.permission === "granted") {
            new Notification(title, { body, icon: user.ava });
        }
    }

    async function loadMsgs() {
        const { data } = await sb.from('messages').select('*').eq('group_id', room).order('created_at',{ascending:true});
        allCurrentMsgs = data;
        renderMessages(data);
    }

    function renderMessages(data) {
        const chat = document.getElementById('chat'); chat.innerHTML = '';
        data.forEach(m => {
            let j = {}; try { j = JSON.parse(m.content); } catch { j = {text: m.content}; }
            const isMe = m.nickname === user.nick;
            const div = document.createElement('div');
            div.className = `msg-box ${isMe ? 'me' : 'other'}`;
            div.onclick = () => setReply(m.nickname, j.text || "Media");

            let html = '';
            if(j.reply) html += `<div class="reply-meta"><b>${j.reply.to}:</b> ${j.reply.txt}</div>`;
            if(j.type === 'image') html += `<img src="${j.url}" style="max-width:100%; border-radius:10px">`;
            else if(j.type === 'loc') html += `<a href="${j.url}" target="_blank" style="color:cyan">üìç M…ôkan</a>`;
            else html += `<div>${j.text || ''}</div>`;
            
            div.innerHTML = `${!isMe ? `<b style="font-size:11px; color:var(--blue)">${m.nickname}</b><br>` : ''}${html}`;
            chat.appendChild(div);
        });
        chat.scrollTop = chat.scrollHeight;
    }

    // AXTARI≈û Sƒ∞STEMƒ∞
    function filterMessages() {
        const term = document.getElementById('searchMsgs').value.toLowerCase();
        const filtered = allCurrentMsgs.filter(m => {
            try { return JSON.parse(m.content).text.toLowerCase().includes(term); } 
            catch { return m.content.toLowerCase().includes(term); }
        });
        renderMessages(filtered);
    }

    // CAVAB VERM∆èK (REPLY)
    function setReply(to, txt) {
        replyTo = { to, txt };
        document.getElementById('replyText').innerText = `${to}: ${txt}`;
        document.getElementById('replyPreview').style.display = 'flex';
        document.getElementById('mInp').focus();
    }
    function cancelReply() {
        replyTo = null;
        document.getElementById('replyPreview').style.display = 'none';
    }

    async function sendMsg(extra = {}) {
        const inp = document.getElementById('mInp');
        const val = inp.value.trim(); if(!val && !extra.type) return;
        
        const payload = { text: val, ...extra };
        if(replyTo) { payload.reply = replyTo; cancelReply(); }
        
        inp.value = '';
        await sb.from('messages').insert([{ nickname: user.nick, group_id: room, content: JSON.stringify(payload) }]);
    }

    // ≈ûƒ∞FR∆èLƒ∞ OTAQLAR
    function createRoom() {
        const name = prompt("Otaq adƒ±:");
        if(!name) return;
        const pass = prompt("≈ûifr…ô qoyulsun? (Bo≈ü buraxsanƒ±z h…ôr k…ôs gir…ô bil…ôr)");
        const roomObj = { name, pass: pass || null };
        rooms.push(roomObj);
        localStorage.setItem('x_rooms', JSON.stringify(rooms));
        switchRoom(roomObj);
    }

    function openRooms() {
        renderRooms();
        openSheet('roomsSheet');
    }

    function renderRooms(filter = "") {
        const area = document.getElementById('roomsListArea'); area.innerHTML = '';
        rooms.forEach(r => {
            const rName = typeof r === 'string' ? r : r.name;
            if(!rName.toLowerCase().includes(filter.toLowerCase())) return;
            
            const btn = document.createElement('button');
            btn.className = 'sheet-btn';
            btn.innerHTML = `üè† ${rName} ${r.pass ? 'üîí' : ''}`;
            btn.onclick = () => switchRoom(r);
            area.appendChild(btn);
        });
    }

    function filterRooms() {
        renderRooms(document.getElementById('searchRooms').value);
    }

    function switchRoom(r) {
        const rName = typeof r === 'string' ? r : r.name;
        if(r.pass) {
            const p = prompt("Bu otaq ≈üifr…ôlidir. ≈ûifr…ôni yazƒ±n:");
            if(p !== r.pass) return alert("S…ôhv ≈üifr…ô!");
        }
        room = rName;
        document.getElementById('roomTitle').innerText = room;
        closeSheets();
        loadMsgs();
    }

    // Dƒ∞G∆èR FUNKSƒ∞YALAR (≈û∆èKƒ∞L, KONUM, SOSƒ∞AL)
    async function uploadFile() {
        const f = document.getElementById('fInp').files[0]; if(!f) return;
        const name = `f_${Date.now()}`;
        await sb.storage.from('audio_messages').upload(name, f);
        const url = `${SB_URL}/storage/v1/object/public/audio_messages/${name}`;
        sendMsg({type:'image', url});
        closeSheets();
    }
    
    function sendLoc() {
        navigator.geolocation.getCurrentPosition(p => {
            const url = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
            sendMsg({type:'loc', url});
            closeSheets();
        });
    }

    function openSheet(id) { document.getElementById(id).classList.add('active'); }
    function closeSheets() { document.querySelectorAll('.sheet-overlay').forEach(s => s.classList.remove('active')); }
    function logout() { localStorage.clear(); location.reload(); }

    checkLogin();
</script>
</body>
</html>
 
