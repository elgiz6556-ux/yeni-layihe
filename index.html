<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X-Chat Pro Final</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --accent: #58a6ff; --my-msg: #238636; --dm: #8957e5; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: #c9d1d9; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header */
        .header { padding: 15px; background: var(--panel); border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; }
        .header b { color: var(--accent); }

        /* Chat List */
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 12px; background: #21262d; position: relative; font-size: 15px; cursor: pointer; }
        .msg.my { align-self: flex-end; background: var(--my-msg); color: white; }
        .msg.is-dm { border: 1px solid var(--dm); box-shadow: 0 0 5px var(--dm); }
        .msg b { display: block; font-size: 11px; margin-bottom: 3px; opacity: 0.8; }
        
        /* DM Alert */
        #dmBox { display: none; background: var(--dm); color: white; padding: 8px; text-align: center; font-size: 13px; font-weight: bold; cursor: pointer; }

        /* Input area */
        .input-bar { padding: 12px; background: var(--panel); display: flex; gap: 10px; align-items: center; border-top: 1px solid #30363d; }
        #msgInp { flex: 1; background: #0d1117; border: 1px solid #30363d; padding: 10px 15px; border-radius: 20px; color: white; outline: none; }
        .btn { border: none; border-radius: 50%; width: 42px; height: 42px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }

        audio { width: 100%; max-width: 200px; height: 30px; filter: invert(1); margin-top: 5px; }
    </style>
</head>
<body>

<div class="header">
    <div><b>X-Chat</b> <span id="myNick" style="font-size: 12px; color:gray"></span></div>
    <div style="display:flex; gap:15px">
        <button onclick="alert('ZÉ™ng sistemi Ã¼Ã§Ã¼n HTTPS vÉ™ kamera icazÉ™si lazÄ±mdÄ±r.')" style="background:none; border:none; font-size:20px;">ðŸ“ž</button>
    </div>
</div>

<div id="dmBox" onclick="closeDM()">ðŸ”’ DM: <span id="dmTarget"></span> (Qrupa qayÄ±tmaq Ã¼Ã§Ã¼n toxun)</div>

<div id="chat"></div>

<div class="input-bar">
    <button class="btn" id="micBtn" onclick="doVoice()" style="background:#30363d; color:white;">ðŸŽ¤</button>
    <input type="text" id="msgInp" placeholder="Mesaj..." autocomplete="off">
    <button class="btn" onclick="doSend()" style="background:var(--accent); color:white;">ðŸš€</button>
</div>

<script>
    const supabaseUrl = 'https://pyknspxnwnilhqsazidj.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a25zcHhud25pbGhxc2F6aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODE0MzAsImV4cCI6MjA4Mjg1NzQzMH0.NlU2cVFug6PH6rZ4RM-344-tPnoYQVrOzWKXOn5y3eU';
    const _sb = supabase.createClient(supabaseUrl, supabaseKey);

    let nick = localStorage.getItem('chat_nick') || prompt("AdÄ±nÄ±z:") || "Qonaq";
    localStorage.setItem('chat_nick', nick);
    document.getElementById('myNick').innerText = "@" + nick;

    let target = 'all';

    // REALTIME - MesajlarÄ± dinlÉ™
    _sb.channel('any').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
        const m = p.new;
        if (m.receiver === 'all' || m.receiver === nick || m.nickname === nick) {
            addMsg(m);
        }
    }).subscribe();

    async function load() {
        const { data } = await _sb.from('messages').select('*').or(`receiver.eq.all,receiver.eq.${nick},nickname.eq.${nick}`).order('created_at', { ascending: true });
        if (data) data.forEach(addMsg);
    }

    function addMsg(m) {
        if (document.getElementById('m-'+m.id)) return;
        const isMy = m.nickname === nick;
        const isDM = m.receiver !== 'all';
        const d = document.createElement('div');
        d.id = 'm-' + m.id;
        d.className = `msg ${isMy ? 'my' : ''} ${isDM ? 'is-dm' : ''}`;
        d.onclick = () => { if(!isMy) openDM(m.nickname); };

        let content = m.content;
        if (content.includes('audio_messages')) {
            content = `<audio src="${content}" controls></audio>`;
        }

        d.innerHTML = `<b>${isDM ? 'ðŸ”’ ' : ''}${m.nickname}</b>${content}`;
        document.getElementById('chat').appendChild(d);
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    async function doSend() {
        const i = document.getElementById('msgInp');
        if (!i.value.trim()) return;
        const text = i.value; i.value = '';
        await _sb.from('messages').insert([{ content: text, nickname: nick, receiver: target }]);
    }

    function openDM(name) {
        target = name;
        document.getElementById('dmBox').style.display = 'block';
        document.getElementById('dmTarget').innerText = name;
    }

    function closeDM() {
        target = 'all';
        document.getElementById('dmBox').style.display = 'none';
    }

    // SÆS YAZMA
    let r, c = [];
    async function doVoice() {
        const b = document.getElementById('micBtn');
        if (!r || r.state === "inactive") {
            const s = await navigator.mediaDevices.getUserMedia({ audio: true });
            r = new MediaRecorder(s);
            c = [];
            r.onstart = () => b.style.background = "red";
            r.ondataavailable = e => c.push(e.data);
            r.onstop = async () => {
                b.style.background = "#30363d";
                const blob = new Blob(c, { type: 'audio/webm' });
                const name = `v_${Date.now()}.webm`;
                const { data } = await _sb.storage.from('audio_messages').upload(name, blob);
                if (data) {
                    const url = `${supabaseUrl}/storage/v1/object/public/audio_messages/${name}`;
                    await _sb.from('messages').insert([{ content: url, nickname: nick, receiver: target }]);
                }
            };
            r.start();
        } else { r.stop(); }
    }

    load();
</script>
</body>
</html>
